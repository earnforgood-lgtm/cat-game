<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± è²“å’ªå°å­¸å ‚ </title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF9F1C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è²“å’ªå°å­¸å ‚">
    <link rel="apple-touch-icon" href="icons/icon-180.png">
    <link rel="icon" href="icons/icon-192.png" sizes="192x192">
    <!-- å¼•å…¥å­—å‹èˆ‡åœ–ç¤ºåº« -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@500;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éŠæˆ²å°ˆå±¬æ¨£å¼ */
        :root {
            --primary: #FF9F1C;
            --secondary: #FFBF69;
            --bg-color: #CBF3F0;
            --text: #2EC4B6;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-position: 0 0, 50px 50px;
            background-size: 100px 100px;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            height: 100dvh;
        }

        /* 3D æŒ‰éˆ•æ•ˆæœ */
        .btn-3d {
            transition: all 0.1s;
            box-shadow: 0px 5px 0px 0px rgba(0,0,0,0.2);
            transform: translateY(0);
            cursor: pointer;
        }
        .btn-3d:active {
            transform: translateY(5px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.2);
        }

        /* å¡ç‰‡ç¿»è½‰æ ¸å¿ƒ */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .card-inner.card-flipped { transform: rotateY(180deg); }

        /* è²“å’ªæµ®å‹•å‹•ç•« */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .cat-anim { animation: float 3s ease-in-out infinite; }

        /* è²“å’ªç”Ÿæ°£æŠ–å‹•å‹•ç•« */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .cat-angry { animation: shake 0.5s; }

        /* Boss å—å‚·å‹•ç•« */
        @keyframes damage-shake {
            0% { transform: translate(0, 0) rotate(0deg); filter: hue-rotate(0deg); }
            20% { transform: translate(-10px, 0) rotate(-5deg); filter: hue-rotate(90deg) brightness(0.5) sepia(1) saturate(1000%) hue-rotate(-50deg); }
            40% { transform: translate(10px, 0) rotate(5deg); }
            60% { transform: translate(-10px, 0) rotate(-5deg); }
            80% { transform: translate(10px, 0) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); filter: none; }
        }
        .boss-damage { animation: damage-shake 0.5s; }

        /* Boss è£œè¡€å‹•ç•« */
        @keyframes heal-glow {
            0% { transform: scale(1); filter: drop-shadow(0 0 0px green); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 20px #00ff00); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0px green); }
        }
        .boss-heal { animation: heal-glow 0.6s; }

        /* Emoji ç²’å­ç‰¹æ•ˆ */
        @keyframes emoji-pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            50% { transform: translate(var(--tx), var(--ty)) scale(1.2) rotate(var(--rot)); opacity: 1; }
            100% { transform: translate(var(--tx), calc(var(--ty) + 30px)) scale(0.8) rotate(var(--rot)); opacity: 0; }
        }
        .emoji-particle {
            position: absolute;
            pointer-events: none;
            font-size: 2rem;
            z-index: 50;
            animation: emoji-pop 0.8s ease-out forwards;
        }

        /* Majic å°è£é£¾ */
        .gene-overlay {
            position: absolute;
            width: 96px;
            height: 96px;
            right: -12px;
            bottom: -6px;
            pointer-events: none;
            border-radius: 999px;
            border: 2px solid #c7d2fe;
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 6px 14px rgba(79, 70, 229, 0.18);
        }
        .organ-container {
            position: absolute;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .organ-source {
            position: absolute;
            font-size: 90px;
            line-height: 1;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            user-select: none;
        }
        .gene-btn {
            background: #f8fafc;
            border: 1px solid #c7d2fe;
            border-radius: 0.75rem;
            padding: 0.35rem;
            font-size: 1.25rem;
            transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
        }
        .gene-btn:hover {
            transform: translateY(-2px);
            border-color: #6366f1;
            background: #eef2ff;
        }
        .gene-btn.selected {
            border-color: #4f46e5;
            background: #e0e7ff;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gene-btn.locked {
            opacity: 0.35;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        @keyframes drift {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0.2; }
            50% { transform: translateY(-12px) translateX(6px) rotate(6deg); opacity: 0.4; }
        }
        .ambient-emoji {
            position: absolute;
            pointer-events: none;
            animation: drift 6s ease-in-out infinite;
        }

        /* åˆæˆç³»çµ±ï¼šEmoji ç–ŠåŠ  */
        .synth-stack {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .synth-layer {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            pointer-events: none;
        }
        .cat-filter-ice { filter: hue-rotate(180deg) saturate(150%) brightness(1.2); }
        .cat-filter-shadow { filter: brightness(0.3) contrast(1.2); }
        .cat-filter-fire { filter: sepia(1) saturate(500%) hue-rotate(-20deg); }
        .cat-filter-stone { filter: grayscale(100%) contrast(1.2); }

        @keyframes float-gentle {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }
        .anim-float { animation: float-gentle 3s ease-in-out infinite; }

        @keyframes spin-slow {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .anim-spin { animation: spin-slow 8s linear infinite; }

        @keyframes shake-angry {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-52%, -48%) rotate(-5deg); }
            75% { transform: translate(-48%, -52%) rotate(5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .anim-shake { animation: shake-angry 0.2s infinite; }

        /* æˆ¿é–“ Emoji è£é£¾ */
        .decor-item {
            position: absolute;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #decor-window { top: 4%; left: 50%; transform: translateX(-50%); font-size: 4.5rem; opacity: 0.85; }
        #decor-rug { bottom: 14%; left: 50%; transform: translateX(-50%) scale(1.35, 1); font-size: 6rem; opacity: 0.9; }
        #decor-toy { bottom: 18%; right: 8%; font-size: 3rem; animation: float 4s ease-in-out infinite; }
        #decor-plant { bottom: 18%; left: 8%; font-size: 3.5rem; }
        #decor-lamp { top: 12%; right: 10%; font-size: 3rem; opacity: 0.9; }
        #decor-balloon { top: 8%; left: 10%; font-size: 3rem; animation: float 5s ease-in-out infinite reverse; }

        /* è¡¨æƒ…ç¬¦è™Ÿå‹•ç•« */
        @keyframes icon-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
        .float-icon {
            position: absolute;
            font-size: 3rem;
            animation: icon-float 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }

        .exp-fill { transition: width 0.5s ease-out; }
        .hp-fill { transition: width 0.3s ease-out; }

        #q-hint {
            white-space: normal;
            word-break: break-word;
            text-align: center;
            line-height: 1.5;
        }

        .story-hint {
            font-size: clamp(0.85rem, 2.3vw, 1.05rem);
        }

        #q-hint-box {
            min-height: 4.5rem;
        }

        .story-mode #q-zhuyin {
            font-size: clamp(1.2rem, 3.4vw, 1.7rem);
        }

        .story-mode #q-hint {
            font-size: clamp(0.78rem, 2.2vw, 0.98rem);
            line-height: 1.6;
        }

        .story-mode #q-hint-box {
            margin-top: 0.5rem !important;
            padding: 0.6rem 0.8rem !important;
            max-height: clamp(9rem, 38vh, 16rem);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .story-mode #q-hint-box span {
            display: none;
        }
        
        #start-screen, #scene-reward, #scene-shop, #scene-synthesis {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* é­”ç‹æˆ°å ´æ™¯èƒŒæ™¯ */
        #scene-boss {
            background: linear-gradient(135deg, #2c0e37 0%, #000000 100%);
        }
    </style>
</head>
<body class="w-screen flex flex-col items-center justify-center text-gray-800">

    <!-- éŸ³æ•ˆè³‡æºåº« -->
    <audio id="bgm" preload="auto"></audio>
    <audio id="sfx-correct" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-extra-bonus-in-a-video-game-2045.wav"></audio>
    <audio id="sfx-wrong" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-game-show-wrong-answer-buzz-950.wav"></audio>
    <audio id="sfx-meow" preload="auto" src="sound/meow1.mp3"></audio>
    <audio id="sfx-real-meow" preload="auto" src="sound/meow2.mp3"></audio>
    <audio id="sfx-angry" preload="auto" src="sound/an1.mp3"></audio>
    <audio id="sfx-levelup" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-quick-win-video-game-notification-269.wav"></audio>
    <audio id="sfx-chew" preload="auto" src="sound/chew.mp3"></audio>
    <audio id="sfx-flip" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-paper-slide-1530.wav"></audio>
    <audio id="sfx-win" preload="auto" src="sound/winner-game.mp3"></audio>
    <audio id="sfx-boss-bgm" preload="auto" src="https://commondatastorage.googleapis.com/codeskulptor-assets/music/race_start.ogg"></audio>
    <audio id="sfx-boss-hit" preload="auto" src="https://commondatastorage.googleapis.com/codeskulptor-assets/sounddogs/missile.mp3"></audio>
    <audio id="sfx-boss-heal" preload="auto" src="https://commondatastorage.googleapis.com/codeskulptor-assets/week7-bounce.m4a"></audio>
    <audio id="sfx-boss-appear" preload="auto" src="https://commondatastorage.googleapis.com/codeskulptor-assets/sounddogs/thrust.mp3"></audio>

    <!-- 0. å•Ÿå‹•ç•«é¢ -->
    <div id="start-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border-4 border-orange-300">
            <div class="text-6xl mb-4 animate-bounce">ğŸ±</div>
            <h1 class="text-3xl font-black text-gray-800 mb-2">è²“å’ªå°å­¸å ‚</h1>
            <p class="text-gray-500 mb-8">æº–å‚™å¥½å¹«è²“å’ªè³ºç½é ­äº†å—ï¼Ÿ</p>
            <button onclick="unlockAudioAndStart()" class="w-full btn-3d bg-orange-500 text-white text-xl font-bold py-4 rounded-xl border-b-4 border-orange-700 active:border-orange-500">
                â–¶ï¸ é»æˆ‘é–‹å§‹éŠæˆ²
            </button>
            <p class="mt-4 text-xs text-gray-400">è«‹ç¢ºèªå¹³æ¿è²éŸ³å·²é–‹å•Ÿ</p>
        </div>
    </div>

    <!-- 1. ä¸»ç•«é¢ (æˆ¿é–“) -->
    <div id="scene-room" class="w-full max-w-md h-full flex flex-col p-4 relative hidden opacity-0 transition-opacity duration-500">
        <div id="room-atmosphere" class="absolute inset-0 w-full h-full pointer-events-none z-0"></div>
        <div id="room-decorations" class="absolute inset-0 w-full h-full pointer-events-none z-0">
            <div id="decor-window" class="decor-item hidden">ğŸ–¼ï¸</div>
            <div id="decor-rug" class="decor-item hidden">ğŸŒˆ</div>
            <div id="decor-toy" class="decor-item hidden">ğŸ§¶</div>
            <div id="decor-plant" class="decor-item hidden">ğŸŒ¿</div>
            <div id="decor-lamp" class="decor-item hidden">ğŸ®</div>
            <div id="decor-balloon" class="decor-item hidden">ğŸˆ</div>
        </div>
        
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
        <div class="flex justify-between items-center bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg mb-2 border-2 border-white z-10">
            <div class="flex items-center gap-2 min-w-fit">
                <span class="text-2xl">ğŸ†</span>
                <span class="font-bold text-lg">Lv.<span id="ui-level">1</span></span>
            </div>
            
            <div class="flex-1 mx-3 flex flex-col justify-center">
                <!-- é€™è£¡è£œå›äº†é¡¯ç¤ºç¶“é©—å€¼çš„æ–‡å­—å€å¡Š -->
                <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                    <span>EXP</span>
                    <span id="ui-exp-text">0/10</span>
                </div>
                <!-- é€²åº¦æ¢ -->
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden border border-gray-300">
                    <div id="ui-exp-bar" class="exp-fill bg-green-400 h-full shadow-[0_0_10px_rgba(74,222,128,0.5)]" style="width: 0%"></div>
                </div>
            </div>

            <button id="btn-music" onclick="toggleMusic()" class="mr-2 p-2 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition">
                ğŸ”Š
            </button>

            <div class="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-xl border border-yellow-200 shadow-sm min-w-fit">
                <span class="text-xl">ğŸ¥«</span>
                <span id="ui-food" class="font-bold text-orange-600">0</span>
            </div>
        </div>

        <!-- è²“å’ªäº’å‹•å€ -->
        <div class="flex-1 flex flex-col items-center justify-center relative min-h-0 z-10">
            <div id="cat-container" class="relative cursor-pointer cat-anim active:scale-95 transition-transform duration-100" onclick="petCat(event)">
                <img id="cat-image" src="https://robohash.org/egg?set=set4&size=250x250" class="w-64 h-64 max-h-[40vh] object-contain drop-shadow-2xl" alt="Cat">
                <div id="synth-stack" class="synth-stack"></div>
                <div id="gene-overlay" class="gene-overlay hidden">
                    <div class="organ-container" style="width: 26px; height: 26px; top: 24px; left: 18px;">
                        <div id="gene-eye-l" class="organ-source">ğŸ¤©</div>
                    </div>
                    <div class="organ-container" style="width: 26px; height: 26px; top: 24px; right: 18px;">
                        <div id="gene-eye-r" class="organ-source">ğŸ¤©</div>
                    </div>
                    <div class="organ-container" style="width: 46px; height: 28px; top: 56px; left: 50%; transform: translateX(-50%);">
                        <div id="gene-mouth" class="organ-source">ğŸ˜º</div>
                    </div>
                </div>
                <div id="cat-speech" class="absolute -top-10 right-0 bg-white p-3 rounded-2xl rounded-bl-none shadow-md text-sm hidden font-bold text-gray-600 animate-bounce">
                    å–µå‘œï½
                </div>
            </div>
            <p class="mt-4 text-gray-500 text-sm bg-white/60 px-6 py-2 rounded-full backdrop-blur-sm shadow-sm animate-pulse">ğŸ‘† é»æ“Šè²“å’ªäº’å‹•</p>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
        <div class="grid grid-cols-3 gap-3 mt-2 mb-4 shrink-0 z-10">
            <button onclick="feedCat(event)" class="btn-3d bg-orange-400 hover:bg-orange-500 text-white py-3 rounded-2xl text-base font-bold flex flex-col items-center justify-center gap-1 border-b-4 border-orange-600">
                <span>ğŸŸ é¤µé£Ÿ</span>
                <span class="text-xs opacity-80">(1exp)</span>
            </button>
            <button onclick="openShop()" class="btn-3d bg-purple-400 hover:bg-purple-500 text-white py-3 rounded-2xl text-base font-bold flex flex-col items-center justify-center gap-1 border-b-4 border-purple-600">
                <span>ğŸ›’ å•†åº—</span>
                <span class="text-xs opacity-80">è²·å®¶å…·</span>
            </button>
            <button onclick="openSynthesis()" class="btn-3d bg-indigo-400 hover:bg-indigo-500 text-white py-3 rounded-2xl text-base font-bold flex flex-col items-center justify-center gap-1 border-b-4 border-indigo-600 relative">
                <span>ğŸ”® åˆæˆ</span>
                <span class="text-xs opacity-80">æ”¶è—</span>
                <div id="synth-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">!</div>
            </button>
            <button onclick="openCatBook()" class="btn-3d bg-amber-400 hover:bg-amber-500 text-white py-3 rounded-2xl text-base font-bold flex flex-col items-center justify-center gap-1 border-b-4 border-amber-600">
                <span>ğŸ“– åœ–é‘‘</span>
                <span class="text-xs opacity-80">å¬å–š</span>
            </button>
            <button onclick="openMenu()" class="btn-3d bg-blue-400 hover:bg-blue-500 text-white py-3 rounded-2xl text-base font-bold flex flex-col items-center justify-center gap-1 border-b-4 border-blue-600">
                <span>âœï¸ å»æ‰“å·¥</span>
                <span class="text-xs opacity-80">è³ºç½é ­</span>
            </button>
        </div>
    </div>

    <!-- 2. é¸èª²é¸å–® -->
    <div id="scene-menu" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out] border-4 border-blue-200 flex flex-col max-h-[90dvh]">
            <h2 class="text-2xl font-black text-center mb-4 text-gray-700 flex items-center justify-center gap-2 shrink-0">
                <span>ğŸ“š</span> é¸æ“‡èª²ç¨‹
            </h2>
            <div class="grid grid-cols-2 gap-3 overflow-y-auto p-1 flex-1" id="lesson-list">
                <!-- JS ç”ŸæˆæŒ‰éˆ• -->
            </div>
            <button onclick="closeMenu()" class="mt-4 w-full py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-xl font-bold btn-3d border-b-4 border-gray-600 shrink-0">è¿”å›æˆ¿é–“</button>
        </div>
    </div>

    <!-- å•†åº— -->
    <div id="scene-shop" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out] border-4 border-purple-200 flex flex-col max-h-[90dvh]">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-black text-purple-600 flex items-center gap-2">
                    <span>ğŸ›’</span> å®¶å…·å•†åº—
                </h2>
                <div class="bg-yellow-100 px-3 py-1 rounded-full text-orange-600 font-bold border border-yellow-300">
                    ğŸ¥« <span id="shop-food-display">0</span>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 p-1 space-y-3" id="shop-list">
                <!-- JS ç”Ÿæˆå•†å“ -->
            </div>
            <button onclick="closeShop()" class="mt-4 w-full py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-xl font-bold btn-3d border-b-4 border-gray-600 shrink-0">é›¢é–‹å•†åº—</button>
        </div>
    </div>

    <!-- åˆæˆ/æ”¶è— -->
    <div id="scene-synthesis" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out] border-4 border-indigo-200 flex flex-col max-h-[90dvh]">
            <h2 class="text-2xl font-black text-indigo-600 mb-2 text-center">ğŸ”® åˆæˆå·¥åŠ</h2>
            <div class="flex mb-4 bg-gray-100 p-1 rounded-lg">
                <button onclick="switchSynthesisTab('synth-tab-craft')" id="btn-synth-tab-craft" class="flex-1 py-2 rounded-md font-bold text-sm bg-white shadow-sm text-indigo-600 transition">ğŸ§ª åˆæˆ</button>
                <button onclick="switchSynthesisTab('synth-tab-collection')" id="btn-synth-tab-collection" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition">ğŸ“– æ”¶è—</button>
                <button onclick="switchSynthesisTab('synth-tab-gene')" id="btn-synth-tab-gene" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition">ğŸª„ Majicå·¥åŠ</button>
            </div>

            <div id="synth-tab-craft" class="flex-1 min-h-0 flex flex-col">
                <div class="flex items-center justify-center gap-3 mb-3 bg-indigo-50 p-3 rounded-xl">
                    <div class="relative w-20 h-20 rounded-2xl bg-white border border-indigo-200 flex items-center justify-center text-3xl">
                        ğŸ±
                        <div id="synth-preview" class="synth-stack"></div>
                    </div>
                    <div class="text-2xl text-indigo-300">+</div>
                    <div id="craft-slot" class="w-16 h-16 border-2 border-dashed border-indigo-300 rounded-xl flex items-center justify-center text-4xl bg-white cursor-pointer" onclick="resetCraftSlot()">â“</div>
                    <div class="text-2xl text-indigo-300">=</div>
                    <button id="btn-synthesize" onclick="doSynthesis()" class="px-4 py-2 bg-gray-300 text-white rounded-lg font-bold shadow-sm" disabled>åˆæˆ</button>
                </div>
                <p id="synth-msg" class="text-xs text-gray-500 mb-2 text-center"></p>
                <p class="text-xs text-gray-400 mb-2">é»é¸ç´ æé€²è¡Œåˆæˆï¼š</p>
                <div id="material-list" class="flex-1 min-h-0 overflow-y-auto grid grid-cols-4 gap-2 content-start p-1">
                    <!-- JS ç”Ÿæˆç´ æ -->
                </div>
            </div>

            <div id="synth-tab-collection" class="hidden flex-1 min-h-0 overflow-y-auto grid grid-cols-2 gap-3 p-1 content-start">
                <!-- JS ç”Ÿæˆæ”¶è— -->
            </div>

            <div id="synth-tab-gene" class="hidden flex-1 min-h-0 flex flex-col">
                <div class="flex items-center justify-between bg-indigo-50 p-3 rounded-xl mb-3">
                    <div>
                        <p class="text-xs text-gray-500">é­”æ³•å°å¤¥ä¼´</p>
                        <h3 id="gene-name" class="text-lg font-black text-indigo-700">ç”œç”œå°å–µ #001</h3>
                        <p id="gene-desc" class="text-xs text-gray-400">é–ƒé–ƒç™¼äº®ã€‚</p>
                    </div>
                    <button onclick="randomGeneMutation()" class="px-3 py-2 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg font-bold text-sm btn-3d">
                        ğŸ² é©šå–œé­”æ³•
                    </button>
                </div>
                <p class="text-[11px] text-gray-400 mb-3">ç´ æå–å¾—ï¼šå®Œæˆé—œå¡æˆ– Boss æœƒæ‰è½ã€‚</p>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <div class="flex items-center gap-2 text-xs text-indigo-500 mb-2">
                            <span>ğŸ‘ï¸</span> çœ¼ç¥ç´ æ
                        </div>
                        <div id="gene-eyes-panel" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 text-xs text-pink-500 mb-2">
                            <span>ğŸ‘„</span> å˜´å·´ç´ æ
                        </div>
                        <div id="gene-mouth-panel" class="grid grid-cols-5 gap-2"></div>
                    </div>
                </div>

                <div class="space-y-3 mb-3">
                    <div>
                        <div class="flex justify-between text-xs text-indigo-400 mb-1">
                            <span>å½©è‰²é­”æ³•</span>
                            <span id="gene-hue-val">0Â°</span>
                        </div>
                        <input id="gene-hue-slider" type="range" min="0" max="360" value="0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-indigo-400 mb-1">
                            <span>æŸ”ç„¦é­”æ³•</span>
                            <span id="gene-blur-val">0</span>
                        </div>
                        <input id="gene-blur-slider" type="range" min="0" max="8" step="0.5" value="0" class="w-full">
                    </div>
                </div>

                <div class="flex gap-2 mb-3">
                    <button onclick="saveGeneMutation()" id="btn-save-gene" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold btn-3d">ğŸ’¾ æ”¶è—é€ å‹</button>
                    <button onclick="resetGeneMutation()" class="flex-1 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold">æ¸…ç©º</button>
                </div>

                <div class="text-xs text-gray-400 mb-1">æˆ‘çš„é­”æ³•æ”¶è—ï¼š</div>
                <div id="gene-collection-list" class="flex-1 min-h-0 overflow-y-auto grid grid-cols-2 gap-2 p-1 content-start"></div>
            </div>

            <button onclick="closeSynthesis()" class="mt-4 w-full py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-xl font-bold btn-3d border-b-4 border-gray-600 shrink-0">è¿”å›æˆ¿é–“</button>
        </div>
    </div>

    <!-- è²“å’ªåœ–é‘‘ -->
    <div id="scene-catbook" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl border-4 border-amber-200 flex flex-col max-h-[85dvh] overflow-hidden">
            <div class="bg-amber-50 p-4 border-b-2 border-amber-200 flex justify-between items-center">
                <h2 class="text-2xl font-black text-amber-600 flex items-center gap-2">ğŸ“– è²“å’ªåœ–é‘‘</h2>
                <div class="text-xs font-bold text-amber-600 bg-white px-2 py-1 rounded-lg shadow-sm border border-amber-200">
                    æ”¶é›†é€²åº¦: <span id="catbook-progress">0/0</span>
                </div>
            </div>
            <div id="catbook-list" class="flex-1 min-h-0 overflow-y-auto grid grid-cols-3 gap-3 p-4 content-start bg-gray-50"></div>
            <div class="p-4 border-t-2 border-gray-100 bg-white">
                <button onclick="closeCatBook()" class="w-full py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-xl font-bold btn-3d border-b-4 border-gray-600 transition">é—œé–‰åœ–é‘‘</button>
            </div>
        </div>
    </div>

    <!-- 3. æˆ°é¬¥ç•«é¢ -->
    <div id="scene-study" class="hidden fixed inset-0 bg-[#FFF3E0] z-40 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md flex justify-between items-center mb-4 px-2">
            <div class="text-gray-500 font-bold">ç¬¬ <span id="q-idx">1</span> é¡Œ</div>
            <button onclick="quitStudy()" class="text-gray-400 hover:text-red-500 font-bold px-3 py-1 rounded-lg hover:bg-red-50 transition">é€ƒè·‘ ğŸ³ï¸</button>
        </div>
        <div class="w-full max-w-md h-3 bg-gray-200 rounded-full mb-8 shadow-inner overflow-hidden">
            <div id="study-progress" class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="perspective-1000 w-full max-w-xs h-96 cursor-pointer mb-8 relative group" onclick="flipCard()">
            <div id="tap-hint" class="absolute -right-4 top-1/2 z-10 animate-bounce bg-white/80 p-2 rounded-full shadow-lg pointer-events-none">ğŸ‘†</div>
            <div id="study-card" class="card-inner relative w-full h-full transform-style-3d shadow-xl rounded-3xl transition-all duration-500">
                <div class="absolute w-full h-full backface-hidden bg-white rounded-3xl flex flex-col items-center justify-center border-4 border-blue-200 shadow-lg p-4">
                    <span class="text-4xl mb-2 opacity-50">ğŸ”Š</span>
                    <h2 id="q-zhuyin" class="text-8xl font-black text-gray-800 tracking-widest my-2 select-none"></h2>
                    <div id="q-hint-box" class="mt-4 bg-blue-50 px-6 py-3 rounded-2xl border border-blue-100 flex items-center justify-center gap-2 w-full">
                        <span class="text-gray-400 text-sm absolute top-2 left-4">æç¤ºï¼š</span>
                        <p id="q-hint" class="text-3xl font-bold text-blue-600 tracking-widest"></p>
                    </div>
                    <p class="text-gray-400 mt-4 text-xs">å¯«å®Œå¾Œé»æˆ‘ç¿»ç‰Œ</p>
                </div>
                <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-blue-50 rounded-3xl flex flex-col items-center justify-center border-4 border-blue-400 shadow-lg p-4">
                    <h2 id="q-char" class="text-9xl font-black text-red-500 mb-2 font-[KaiTi] select-none"></h2>
                    <div class="flex flex-col items-center gap-2 w-full">
                         <p id="q-radical" class="text-lg bg-blue-200 text-blue-900 px-3 py-1 rounded-lg font-bold shadow-sm"></p>
                         <div class="w-full bg-white/50 rounded-xl py-2 mt-2">
                            <p id="a-word" class="text-2xl font-bold text-gray-700"></p>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="study-controls" class="hidden flex gap-4 w-full max-w-md animate-[fadeIn_0.5s_ease-out]">
            <button onclick="answer(false)" class="flex-1 py-4 bg-red-400 hover:bg-red-500 text-white rounded-2xl font-bold shadow-md transform transition active:scale-95 border-b-4 border-red-600 text-lg">âŒ å†ç·´ä¸€æ¬¡</button>
            <button onclick="answer(true)" class="flex-1 py-4 bg-green-400 hover:bg-green-500 text-white rounded-2xl font-bold shadow-md transform transition active:scale-95 border-b-4 border-green-600 text-lg">âœ… æˆ‘å¯«å°äº†</button>
        </div>
    </div>

    <!-- 4. é­”ç‹æˆ° -->
    <div id="scene-boss" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md flex items-center justify-between mb-2">
            <h2 class="text-white text-xl font-black animate-pulse">âš ï¸ éŒ¯å­—æ€ªç¸å‡ºç¾äº†ï¼</h2>
            <button onclick="quitStudy()" class="text-white/70 hover:text-white font-bold px-3 py-1 rounded-lg hover:bg-white/10 transition">æ’¤é€€ ğŸ³ï¸</button>
        </div>
        <div class="w-full max-w-md bg-gray-700 rounded-full h-6 border-2 border-white overflow-hidden relative mb-4">
            <div id="boss-hp-bar" class="hp-fill bg-red-600 h-full w-full"></div>
            <span class="absolute inset-0 flex items-center justify-center text-xs text-white font-bold">HP: <span id="boss-hp-text">100</span>/<span id="boss-hp-max">100</span></span>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center relative w-full">
            <img id="boss-image" src="https://robohash.org/monster?set=set2&size=300x300" class="w-64 h-64 drop-shadow-[0_0_15px_rgba(255,0,0,0.8)] object-contain transition-transform">
            <div id="boss-effect" class="absolute text-6xl font-bold transition-all opacity-0" style="top:20%;"></div>
        </div>

        <div class="w-full max-w-md bg-white rounded-2xl p-4 shadow-2xl mt-4 border-4 border-red-500 relative">
            <div class="text-center">
                <p class="text-gray-500 text-sm mb-1">è«‹å¯«å‡ºé€™å€‹å­—æ”»æ“Šç‰ ï¼</p>
                <h2 id="boss-q-zhuyin" class="text-6xl font-black text-gray-800 my-2"></h2>
                <p id="boss-q-word" class="text-xl text-blue-600 font-bold"></p>
            </div>
            
            <div id="boss-answer-mask" class="absolute inset-0 bg-gray-800/90 rounded-xl flex items-center justify-center cursor-pointer transition-opacity z-10" onclick="revealBossAnswer()">
                <p class="text-white text-2xl font-bold animate-bounce">ğŸ‘† é»æˆ‘çœ‹ç­”æ¡ˆæ”»æ“Š</p>
            </div>

            <div id="boss-answer-area" class="hidden mt-4 pt-4 border-t-2 border-gray-100 flex flex-col items-center">
                <h2 id="boss-a-char" class="text-6xl text-red-500 font-[KaiTi]"></h2>
                <div class="flex gap-2 mt-4 w-full">
                    <button onclick="attackBoss(false)" class="flex-1 py-3 bg-red-200 text-red-800 rounded-xl font-bold">æ²’å¯«å° (æ€ªç¸è£œè¡€)</button>
                    <button onclick="attackBoss(true)" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold">å¯«å°äº† (ç™¼å°„ç«çƒ)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. çµç®—çå‹µç•«é¢ -->
    <div id="scene-reward" class="hidden fixed inset-0 z-[9999] flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border-4 border-yellow-300 relative">
            <h2 id="reward-title" class="text-4xl font-black text-yellow-500 mb-4 animate-bounce">ğŸ‰ æ­å–œéé—œï¼</h2>
            <div id="reward-icon" class="text-8xl mb-4">ğŸ¥«</div>
            <p class="text-2xl text-gray-700 mb-6 font-bold">ç²å¾—äº† <span id="reward-count" class="text-red-500 text-4xl">0</span> å€‹<span id="reward-type">ç½é ­</span></p>
            <p id="reward-extra" class="text-sm text-gray-500 mb-2 hidden"></p>
            <p id="reward-extra-majic" class="text-sm text-gray-500 mb-2 hidden"></p>
            <p id="reward-exp-info" class="text-sm text-gray-400 mb-4 hidden">ç²å¾— 50 é»ç¶“é©—å€¼ï¼</p>
            <button onclick="collectReward(event)" class="w-full btn-3d bg-green-500 text-white text-xl font-bold py-4 rounded-xl border-b-4 border-green-700 active:border-green-500" style="pointer-events: auto;">
                ğŸ’° æ”¶ä¸‹çå‹µå›å®¶
            </button>
        </div>
    </div>

    <!-- å‡ç´šç‰¹æ•ˆ -->
    <div id="levelup-overlay" class="hidden fixed inset-0 bg-black/80 z-[80] flex flex-col items-center justify-center text-white text-center pointer-events-none">
        <h1 class="text-7xl font-bold text-yellow-300 mb-4 animate-bounce drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">LEVEL UP!</h1>
        <p class="text-3xl font-bold text-white mb-8">è²“å’ªé€²åŒ–äº†ï¼âœ¨</p>
        <div class="text-6xl animate-pulse">ğŸ˜»</div>
    </div>

<script>
    // --- 0. è³‡æ–™åº« ---
    const lessons = {
        "7": { title: "ç¬¬ä¸ƒèª²", words: [
            {c:"æ¨£",z:"ã„§ã„¤Ë‹",r:"æœ¨éƒ¨",w:"æ¨£å­"}, {c:"é£Ÿ",z:"ã„•ËŠ",r:"é£Ÿéƒ¨",w:"é£Ÿå“"}, {c:"éƒŠ",z:"ã„ã„§ã„ ",r:"é‚‘éƒ¨",w:"éƒŠå¤–"}, {c:"æ´»",z:"ã„ã„¨ã„›ËŠ",r:"æ°´éƒ¨",w:"ç”Ÿæ´»"},
            {c:"å¥‡",z:"ã„‘ã„§ËŠ",r:"å¤§éƒ¨",w:"å¥‡æ€ª"}, {c:"ç­’",z:"ã„Šã„¨ã„¥Ë‡",r:"ç«¹éƒ¨",w:"ç«¹ç­’"}, {c:"é¦™",z:"ã„’ã„§ã„¤",r:"é¦™éƒ¨",w:"é¦™æ°´"}, {c:"å‘³",z:"ã„¨ã„ŸË‹",r:"å£éƒ¨",w:"å‘³é“"},
            {c:"ä¾¿",z:"ã„…ã„§ã„¢Ë‹",r:"äººéƒ¨",w:"æ–¹ä¾¿"}, {c:"ç•¶",z:"ã„‰ã„¤",r:"ç”°éƒ¨",w:"ä¾¿ç•¶"}, {c:"ç›’",z:"ã„ã„œËŠ",r:"çš¿éƒ¨",w:"ç›’å­"}, {c:"å®¢",z:"ã„ã„œË‹",r:"å®€éƒ¨",w:"å®¢äºº"},
            {c:"æ¸…",z:"ã„‘ã„§ã„¥",r:"æ°´éƒ¨",w:"æ¸…æ°´"}, {c:"ç¯€",z:"ã„ã„§ã„ËŠ",r:"ç«¹éƒ¨",w:"ç¯€æ—¥"}, {c:"ä¿",z:"ã„…ã„ Ë‡",r:"äººéƒ¨",w:"ä¿è­·"}, {c:"å¹³",z:"ã„†ã„§ã„¥ËŠ",r:"å¹²éƒ¨",w:"å¹³å®‰"},
            {c:"å®‰",z:"ã„¢",r:"å®€éƒ¨",w:"å®‰å…¨"}, {c:"å—",z:"ã„‹ã„¢ËŠ",r:"åéƒ¨",w:"å—æ–¹"}
        ]},
        "8": { title: "ç¬¬å…«èª²", words: [
            {c:"ä»‹",z:"ã„ã„§ã„Ë‹",r:"äººéƒ¨",w:"ä»‹ç´¹"}, {c:"åœ’",z:"ã„©ã„¢ËŠ",r:"å›—éƒ¨",w:"å…¬åœ’"}, {c:"å½¢",z:"ã„’ã„§ã„¥ËŠ",r:"å½¡éƒ¨",w:"å½¢ç‹€"}, {c:"ç™½",z:"ã„…ã„ËŠ",r:"ç™½éƒ¨",w:"ç™½è‰²"},
            {c:"ç´™",z:"ã„“Ë‡",r:"ç³¸éƒ¨",w:"ç™½ç´™"}, {c:"ç±³",z:"ã„‡ã„§Ë‡",r:"ç±³éƒ¨",w:"ç™½ç±³"}, {c:"è®Š",z:"ã„…ã„§ã„¢Ë‹",r:"è¨€éƒ¨",w:"æ”¹è®Š"}, {c:"è»Ÿ",z:"ã„–ã„¨ã„¢Ë‡",r:"è»Šéƒ¨",w:"æŸ”è»Ÿ"},
            {c:"æ¶",z:"ã„‘ã„§ã„¤Ë‡",r:"æ‰‹éƒ¨",w:"æ¶èµ°"}, {c:"æ",z:"ã„˜ã„ËŠ",r:"æœ¨éƒ¨",w:"ææ–™"}, {c:"è¦",z:"ã„’ã„§ã„š",r:"è™«éƒ¨",w:"è¦å­"}, {c:"ç·š",z:"ã„’ã„§ã„¢Ë‹",r:"ç³¸éƒ¨",w:"æ¯›ç·š"},
            {c:"å„",z:"ã„ã„œË‹",r:"å£éƒ¨",w:"å„ç¨®"}, {c:"ç¨®",z:"ã„“ã„¨ã„¥Ë‡",r:"ç¦¾éƒ¨",w:"ç¨®å­"}, {c:"èœ",z:"ã„˜ã„Ë‹",r:"è‰¸éƒ¨",w:"é’èœ"}, {c:"è½",z:"ã„Šã„§ã„¥",r:"è€³éƒ¨",w:"è½è¦‹"},
            {c:"æ›´",z:"ã„ã„¥Ë‹",r:"æ›°éƒ¨",w:"æ›´åŠ "}, {c:"æ¥",z:"ã„ã„§ã„",r:"æ‰‹éƒ¨",w:"æ¥å—"}
        ]},
        "9": { title: "ç¬¬ä¹èª²", words: [
            {c:"é»ƒ",z:"ã„ã„¨ã„¤ËŠ",r:"é»ƒéƒ¨",w:"é»ƒè‰²"}, {c:"æ²–",z:"ã„”ã„¨ã„¥",r:"æ°´éƒ¨",w:"æ²–æ´—"}, {c:"æ¾¡",z:"ã„—ã„ Ë‡",r:"æ°´éƒ¨",w:"æ´—æ¾¡"}, {c:"è˜¿",z:"ã„Œã„¨ã„›ËŠ",r:"è‰¸éƒ¨",w:"è˜¿è””"},
            {c:"è””",z:"ã„…ã„›Ë™",r:"è‰¸éƒ¨",w:"è˜¿è””"}, {c:"å“ª",z:"ã„‹ã„šË‡",r:"å£éƒ¨",w:"å“ªè£¡"}, {c:"ç²’",z:"ã„Œã„§Ë‹",r:"ç±³éƒ¨",w:"ç±³ç²’"}, {c:"ç†±",z:"ã„–ã„œË‹",r:"ç«éƒ¨",w:"ç†±é¬§"},
            {c:"æµ´",z:"ã„©Ë‹",r:"æ°´éƒ¨",w:"æµ´å®¤"}, {c:"è’¸",z:"ã„“ã„¥",r:"ç«éƒ¨",w:"è’¸æ°£"}, {c:"èƒ–",z:"ã„†ã„¤Ë‹",r:"è‚‰éƒ¨",w:"è‚¥èƒ–"}, {c:"å",z:"ã„‡ã„§ã„¥ËŠ",r:"å£éƒ¨",w:"åå­—"},
            {c:"è‹”",z:"ã„Šã„ËŠ",r:"è‰¸éƒ¨",w:"é’è‹”"}, {c:"è›‹",z:"ã„‰ã„¢Ë‹",r:"è™«éƒ¨",w:"é›è›‹"}, {c:"è”¬",z:"ã„•ã„¨",r:"è‰¸éƒ¨",w:"è”¬èœ"}, {c:"é€š",z:"ã„Šã„¨ã„¥",r:"è¾µéƒ¨",w:"é€šé"},
            {c:"ç´°",z:"ã„’ã„§Ë‹",r:"ç³¸éƒ¨",w:"ç´°å°"}
        ]},
        "10": { title: "ç¬¬åèª²", words: [
            {c:"æ¸›",z:"ã„ã„§ã„¢Ë‡",r:"æ°´éƒ¨",w:"æ¸›å°‘"}, {c:"è¡¨",z:"ã„…ã„§ã„ Ë‡",r:"è¡£éƒ¨",w:"èª²è¡¨"}, {c:"è®€",z:"ã„‰ã„¨ËŠ",r:"è¨€éƒ¨",w:"è®€æ›¸"}, {c:"èª",z:"ã„–ã„£Ë‹",r:"è¨€éƒ¨",w:"èªè­˜"},
            {c:"è­˜",z:"ã„•Ë‹",r:"è¨€éƒ¨",w:"çŸ¥è­˜"}, {c:"è¬",z:"ã„‡ã„§ËŠ",r:"è¨€éƒ¨",w:"è¬é¡Œ"}, {c:"ç­”",z:"ã„‰ã„šËŠ",r:"ç«¹éƒ¨",w:"å›ç­”"}, {c:"æ–",z:"ã„§ã„ ËŠ",r:"æ‰‹éƒ¨",w:"æ–é ­"},
            {c:"ç™¾",z:"ã„…ã„Ë‡",r:"ç™½éƒ¨",w:"ä¸€ç™¾"}, {c:"å˜´",z:"ã„—ã„¨ã„ŸË‡",r:"å£éƒ¨",w:"å˜´å·´"}, {c:"å“¥",z:"ã„ã„œ",r:"å£éƒ¨",w:"å“¥å“¥"}, {c:"æ•¸",z:"ã„•ã„¨Ë‹",r:"æ”µéƒ¨",w:"æ•¸å­¸"},
            {c:"é¡Œ",z:"ã„Šã„§ËŠ",r:"é éƒ¨",w:"é¡Œç›®"}, {c:"è¶•",z:"ã„ã„¢Ë‡",r:"èµ°éƒ¨",w:"è¶•å¿«"}, {c:"çª",z:"ã„Šã„¨ËŠ",r:"ç©´éƒ¨",w:"çªç„¶"}, {c:"ç•°",z:"ã„§Ë‹",r:"ç”°éƒ¨",w:"å¥‡ç•°"},
            {c:"å£",z:"ã„ã„¡Ë‡",r:"å£éƒ¨",w:"å£è¢‹"}, {c:"å°",z:"ã„‰ã„¨ã„ŸË‹",r:"å¯¸éƒ¨",w:"å°éŒ¯"}
        ]},
        "11": { title: "ç¬¬åä¸€èª²", words: [
            {c:"æ€ª",z:"ã„ã„¨ã„Ë‹",r:"å¿ƒéƒ¨",w:"å¥‡æ€ª"}, {c:"é–€",z:"ã„‡ã„£ËŠ",r:"é–€éƒ¨",w:"å¤§é–€"}, {c:"æ‰‡",z:"ã„•ã„¢Ë‹",r:"æˆ¶éƒ¨",w:"é›»æ‰‡"}, {c:"ç«‹",z:"ã„Œã„§Ë‹",r:"ç«‹éƒ¨",w:"èµ·ç«‹"},
            {c:"åˆ»",z:"ã„ã„œË‹",r:"åˆ€éƒ¨",w:"ç«‹åˆ»"}, {c:"é–’",z:"ã„’ã„§ã„¢ËŠ",r:"é–€éƒ¨",w:"ç©ºé–’"}, {c:"é¦¬",z:"ã„‡ã„šË‡",r:"é¦¬éƒ¨",w:"é¦¬è·¯"}, {c:"é—–",z:"ã„”ã„¨ã„¤Ë‡",r:"é–€éƒ¨",w:"é—–é—œ"},
            {c:"è€³",z:"ã„¦Ë‡",r:"è€³éƒ¨",w:"è€³æœµ"}, {c:"ä¸»",z:"ã„“ã„¨Ë‡",r:"ä¸¶éƒ¨",w:"ä¸»äºº"}, {c:"æ’­",z:"ã„…ã„›",r:"æ‰‹éƒ¨",w:"å»£æ’­"}, {c:"å ±",z:"ã„…ã„ Ë‹",r:"åœŸéƒ¨",w:"å ±å‘Š"},
            {c:"åŠ›",z:"ã„Œã„§Ë‹",r:"åŠ›éƒ¨",w:"åŠ›æ°£"}, {c:"ç«Ÿ",z:"ã„ã„§ã„¥Ë‹",r:"ç«‹éƒ¨",w:"ç«Ÿç„¶"}, {c:"å·´",z:"ã„…ã„š",r:"å·³éƒ¨",w:"å°¾å·´"}, {c:"æ±",z:"ã„‰ã„¨ã„¥",r:"æœ¨éƒ¨",w:"æ±è¥¿"},
            {c:"è¥¿",z:"ã„’ã„§",r:"è¥¾éƒ¨",w:"è¥¿ç“œ"}, {c:"åº•",z:"ã„‰ã„§Ë‡",r:"å»£éƒ¨",w:"åº•ä¸‹"}
        ]},
        "12": { title: "ç¬¬åäºŒèª²", words: [
            {c:"å¿µ",z:"ã„‹ã„§ã„¢Ë‹",r:"å¿ƒéƒ¨",w:"æ€å¿µ"}, {c:"æ›²",z:"ã„‘ã„©Ë‡",r:"æ›°éƒ¨",w:"æ­Œæ›²"}, {c:"é …",z:"ã„’ã„§ã„¤Ë‹",r:"é éƒ¨",w:"é …ç›®"}, {c:"æµ®",z:"ã„ˆã„¨ËŠ",r:"æ°´éƒ¨",w:"æµ®åŠ›"},
            {c:"æŒ",z:"ã„“ã„¤Ë‡",r:"æ‰‹éƒ¨",w:"æ‰‹æŒ"}, {c:"æ’¥",z:"ã„…ã„›",r:"æ‰‹éƒ¨",w:"æ’¥é–‹"}, {c:"æ³¢",z:"ã„…ã„›",r:"æ°´éƒ¨",w:"æ³¢æµª"}, {c:"è©©",z:"ã„•",r:"è¨€éƒ¨",w:"è©©äºº"},
            {c:"ä½œ",z:"ã„—ã„¨ã„›Ë‹",r:"äººéƒ¨",w:"ä½œæ¥­"}, {c:"é¦–",z:"ã„•ã„¡Ë‡",r:"é¦–éƒ¨",w:"é¦–å…ˆ"}, {c:"æŒ‡",z:"ã„“Ë‡",r:"æ‰‹éƒ¨",w:"æ‰‹æŒ‡"}, {c:"ä¼¸",z:"ã„•ã„£",r:"äººéƒ¨",w:"ä¼¸æ‰‹"},
            {c:"è„–",z:"ã„…ã„›ËŠ",r:"è‚‰éƒ¨",w:"è„–å­"}, {c:"èº«",z:"ã„•ã„£",r:"èº«éƒ¨",w:"èº«é«”"}, {c:"é«”",z:"ã„Šã„§Ë‡",r:"éª¨éƒ¨",w:"é«”è‚²"}, {c:"éš»",z:"ã„“",r:"éš¹éƒ¨",w:"ä¸€éš»"},
            {c:"å€’",z:"ã„‰ã„ Ë‡",r:"äººéƒ¨",w:"è·Œå€’"}, {c:"è‚š",z:"ã„‰ã„¨Ë‹",r:"è‚‰éƒ¨",w:"è‚šå­"}
        ]},
        "R": { title: "å…¨ç¯„åœéš¨æ©Ÿ (10é¡Œ)", mode: "random10", words: Array(10).fill(null) },
        "M": { title: "æ•¸å­¸é¡Œ (10é¡Œ)", mode: "math10", words: Array(10).fill(null) }
    };

    // --- 1. éŠæˆ²ç‹€æ…‹ç®¡ç† ---
    let gameState = {
        level: 1,
        exp: 0,
        food: 0,
        musicOn: true,
        inventory: [],
        materialInventory: [],
        synthUnlocked: [0],
        synthCurrent: 0,
        synthHasNew: false,
        unlockedCats: [0],
        currentCatIndex: 0,
        geneEyes: 'ğŸ¤©',
        geneMouth: 'ğŸ˜º',
        geneHue: 0,
        geneBlur: 0,
        geneMutations: [],
        geneCurrentId: null,
        geneActive: false,
        geneName: 'ç”œç”œå°å–µ #001',
        geneDesc: 'é–ƒé–ƒç™¼äº®ã€‚',
        geneEyeMaterials: ['ğŸ¤©', 'ğŸ˜', 'ğŸ˜'],
        geneMouthMaterials: ['ğŸ˜º', 'ğŸ˜‹', 'ğŸ˜']
    };

    const shopItems = [
        { id: 'decor-window', name: 'é¢¨æ™¯çª—æˆ¶', price: 20, icon: 'ğŸ–¼ï¸', desc: 'çœ‹çœ‹å¤–é¢çš„ä¸–ç•Œ' },
        { id: 'decor-rug', name: 'å½©è™¹åœ°æ¯¯', price: 15, icon: 'ğŸŒˆ', desc: 'è»Ÿç¶¿ç¶¿çš„è§¸æ„Ÿ' },
        { id: 'decor-toy', name: 'æ¯›ç·šçƒ', price: 10, icon: 'ğŸ§¶', desc: 'è²“å’ªæœ€æ„›ç©å…·' },
        { id: 'decor-plant', name: 'ç¶ è‰²ç›†æ ½', price: 15, icon: 'ğŸŒ¿', desc: 'æ¸…æ–°å°è§’è½' },
        { id: 'decor-lamp', name: 'ç´…ç‡ˆç± ', price: 25, icon: 'ğŸ®', desc: 'å¢æ·»æ°£æ°›' },
        { id: 'decor-balloon', name: 'æ°£çƒ', price: 10, icon: 'ğŸˆ', desc: 'é£„ä¾†é£„å»' }
    ];

    const synthMaterials = [
        { id: 'item-glass', name: 'æ”¾å¤§é¡', icon: 'ğŸ”', desc: 'åµæ¢è£å‚™', styleId: 3 },
        { id: 'item-rocket', name: 'ç©å…·ç«ç®­', icon: 'ğŸš€', desc: 'é£›å‘å®‡å®™', styleId: 4, rare: true },
        { id: 'item-guitar', name: 'é›»å‰ä»–', icon: 'ğŸ¸', desc: 'æ–æ»¾ç¯€å¥', styleId: 5 },
        { id: 'item-blood', name: 'ç•ªèŒ„æ±', icon: 'ğŸ·', desc: 'å¸è¡€é¬¼é¢¨å‘³', styleId: 6 },
        { id: 'item-cone', name: 'å†°æ·‡æ·‹', icon: 'ğŸ¦', desc: 'ç”œç­’ç•¶è§’', styleId: 7 },
        { id: 'item-shrimp', name: 'ç‚¸è¦æŠ±æ•', icon: 'ğŸ¤', desc: 'é…¥é…¥é¦™é¦™', styleId: 8 },
        { id: 'item-toilet', name: 'é¦¬æ¡¶', icon: 'ğŸš½', desc: 'æ¢éšªå®¶å°ˆç”¨', styleId: 9 },
        { id: 'item-ice', name: 'æ°¸å‡å†°å¡Š', icon: 'ğŸ§Š', desc: 'å†°éœœåŠ›é‡', styleId: 10, rare: true },
        { id: 'item-fire', name: 'é­”æ³•ç«æŠŠ', icon: 'ğŸ”¥', desc: 'ç‚ç†±èƒ½é‡', styleId: 11, rare: true }
    ];

    const synthStyles = {
        0: { name: 'åŸå‘³è²“å’ª', desc: 'ä¿ç•™åŸæœ¬çš„æ¨£å­', layers: [] },
        3: { name: 'ååµæ¢å–µå–µ', desc: 'çœŸç›¸åªæœ‰ä¸€å€‹', layers: [
            { icon: 'ğŸ§¥', size: 5.2, top: 70, z: 1 },
            { icon: 'ğŸ§', size: 3, top: 35, left: 62, z: 2 },
            { icon: 'ğŸ§¢', size: 4, top: 15, z: 2 },
            { icon: 'ğŸ”', size: 3.5, top: 60, left: 78, z: 3, rotate: -20 }
        ]},
        4: { name: 'å¤ªç©ºäººå–µå–µ', desc: 'å‘¼å«æ§åˆ¶å¡”', layers: [
            { icon: 'ğŸ”®', size: 8, opacity: 0.6, z: 2 },
            { icon: 'ğŸš€', size: 3.6, top: 20, left: 85, z: 0, anim: 'anim-float' },
            { icon: 'ğŸŒŒ', size: 9, opacity: 0.7, z: -1 }
        ]},
        5: { name: 'æ–æ»¾å·¨æ˜Ÿ', desc: 'å‘¼åš•è²æ˜¯é‡é‡‘å±¬', layers: [
            { icon: 'ğŸ•¶ï¸', size: 3.5, top: 40, z: 2 },
            { icon: 'ğŸ¸', size: 4.5, top: 75, left: 35, z: 3, rotate: 35 },
            { icon: 'âš¡', size: 3, top: 12, left: 85, anim: 'anim-shake' }
        ]},
        6: { name: 'å¸è¡€é¬¼ä¼¯çˆµ', desc: 'åªå–ç•ªèŒ„æ±', layers: [
            { icon: 'ğŸ‘¿', size: 7.5, top: 40, z: -1 },
            { icon: 'ğŸ©', size: 3.6, top: 12, z: 2 },
            { icon: 'ğŸ·', size: 3, top: 75, left: 75, z: 2 }
        ], catFilter: 'cat-filter-shadow' },
        7: { name: 'å½©è™¹ç¨è§’å–µ', desc: 'çœ‹åˆ°ç‰ ä½œæ¥­éƒ½æœƒå…¨å°', layers: [
            { icon: 'ğŸ¦', size: 3, top: 15, rotate: -15, z: 2 },
            { icon: 'ğŸŒˆ', size: 8, top: 55, opacity: 0.8, z: -1 },
            { icon: 'âœ¨', size: 3, top: 10, left: 85, anim: 'anim-spin' }
        ]},
        8: { name: 'ç‚¸è¦ç¡è¢‹å–µ', desc: 'çœ‹èµ·ä¾†å¾ˆå¥½åƒ', layers: [
            { icon: 'ğŸ¤', size: 8.5, rotate: 35, z: 2 }
        ]},
        9: { name: 'é¦¬æ¡¶æ¢éšªå®¶', desc: 'é€™æ°´å‘³é“æ€ªæ€ªçš„', layers: [
            { icon: 'ğŸš½', size: 8, z: 2 },
            { icon: 'ğŸ˜¨', size: 3, top: 30, left: 80, z: 3 }
        ]},
        10: { name: 'å†°éœœå–µ', desc: 'é è¿‘ç‰ å†·æ°£è²»éƒ½çœäº†', layers: [
            { icon: 'â„ï¸', size: 3, top: 12, left: 15, anim: 'anim-spin' },
            { icon: 'ğŸ§Š', size: 3.5, top: 80, left: 85 }
        ], catFilter: 'cat-filter-ice' },
        11: { name: 'ç‚æŸ±å–µ', desc: 'ç‰ ç¾åœ¨éå¸¸ç†±æƒ…', layers: [
            { icon: 'ğŸ”¥', size: 3.8, top: 82, z: 2 },
            { icon: 'ğŸ˜¡', size: 3, top: 40, z: 3 }
        ], catFilter: 'cat-filter-fire' }
    };

    const ROOM_ATMOSPHERE_LIST = ['â˜ï¸', 'ğŸŒ¸', 'âœ¨', 'ğŸµ', 'ğŸŒ±', 'ğŸŒ™', 'ğŸ’«'];
    const CAT_SPEECH_LIST = ['å–µå—šï½', 'å†æ‘¸ä¸€ä¸‹ï¼', 'ç½é ­åœ¨å“ªï¼Ÿ', 'ä¸€èµ·å­¸ç¿’ï¼', 'ä½ çœŸå²å®³ï¼'];
    const GENE_EYES = ['ğŸ¤©', 'ğŸ˜', 'ğŸ˜', 'ğŸ¥º', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜´', 'ğŸ¤—', 'ğŸ˜º', 'ğŸ˜»'];
    const GENE_MOUTHS = ['ğŸ˜º', 'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜®', 'ğŸ˜œ', 'ğŸ™‚', 'ğŸ¥³', 'ğŸ¤­', 'ğŸ˜‡'];
    const GENE_ADJECTIVES = ['å½©è™¹', 'æ˜Ÿæ˜Ÿ', 'æ³¡æ³¡', 'å¤¢å¹»', 'é–‹å¿ƒ', 'ç”œç”œ', 'é™½å…‰', 'é–ƒäº®'];
    const GENE_NOUNS = ['å°å–µ', 'å°ç²¾éˆ', 'å°æ³¡æ³¡', 'å°æ˜Ÿæ˜Ÿ', 'é­”æ³•è²“', 'ç”œç”œè²“', 'å½©è™¹è²“', 'å¿ƒæƒ…è²“'];
    const GENE_DESCS = [
        'ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼',
        'çœ¼ç›äº®æ™¶æ™¶ã€‚',
        'å……æ»¿é­”æ³•èƒ½é‡ï½',
        'å¥½æƒ³æŠ±æŠ±å®ƒï¼',
        'æ­£åœ¨ç™¼å…‰ä¸­ã€‚'
    ];
    
    const EXP_PER_LEVEL = 10;
    const HAPPY_MEOW_LIST = [
        "sound/meow1.mp3",
        "sound/meow2.mp3",
        "sound/meow3.mp3",
        "sound/meow4.mp3"
    ];
    const ANGRY_MEOW_LIST = [
        "sound/an1.mp3",
        "sound/an2.mp3"
    ];
    const BGM_LIST = [
        "music/å…”å…’è·³ä¸åœ.mp3",
        "music/æ´—æ´—ç¢—.mp3",
        "music/æ´—ç¢—.mp3",
        "music/æ´—ç¢—æ´—ç¢—æ´—ç¢—ç¢—.mp3",
        "music/è¦æ‹‰æ‹‰ .mp3"
    ];
    let currentBgmUrl = "";
    let bgmQueue = [];
    let bgmWasPlaying = false;
    let bossBgmWasPlaying = false;

    const catSprites = [
        "https://robohash.org/egg?set=set4&size=250x250", 
        "https://robohash.org/baby_kitten?set=set4&size=250x250", 
        "https://robohash.org/playful_cat?set=set4&size=250x250", 
        "https://robohash.org/smart_cat?set=set4&size=250x250", 
        "https://robohash.org/ninja_cat?set=set4&size=250x250", 
        "https://robohash.org/wizard_cat?set=set4&size=250x250",
        "https://robohash.org/king_cat?set=set4&size=250x250",
        "https://robohash.org/queen_cat?set=set4&size=250x250",
        "https://robohash.org/angel_cat?set=set4&size=250x250",
        "https://robohash.org/demon_cat?set=set4&size=250x250",
        "https://robohash.org/space_cat?set=set4&size=250x250",
        "https://robohash.org/robot_cat?set=set4&size=250x250",
        "https://robohash.org/ghost_cat?set=set4&size=250x250",
        "https://robohash.org/super_cat?set=set4&size=250x250",
        "https://robohash.org/mega_cat?set=set4&size=250x250",
        "https://robohash.org/ultra_cat?set=set4&size=250x250",
        "https://robohash.org/rainbow_cat?set=set4&size=250x250",
        "https://robohash.org/golden_cat?set=set4&size=250x250",
        "https://robohash.org/crystal_cat?set=set4&size=250x250",
        "https://robohash.org/shadow_cat?set=set4&size=250x250",
        "https://robohash.org/fire_cat?set=set4&size=250x250",
        "https://robohash.org/water_cat?set=set4&size=250x250",
        "https://robohash.org/earth_cat?set=set4&size=250x250",
        "https://robohash.org/wind_cat?set=set4&size=250x250",
        "https://robohash.org/god_cat?set=set4&size=250x250"
    ];

    function clampCatIndex(index) {
        if (!Number.isFinite(index)) return 0;
        return Math.max(0, Math.min(index, catSprites.length - 1));
    }

    function unlockCatSkin(index, autoEquip) {
        if (!Array.isArray(gameState.unlockedCats)) gameState.unlockedCats = [0];
        const safeIndex = clampCatIndex(index);
        if (!gameState.unlockedCats.includes(safeIndex)) {
            gameState.unlockedCats.push(safeIndex);
        }
        if (autoEquip) {
            gameState.currentCatIndex = safeIndex;
        }
    }

    // --- Boss æˆ°è®Šæ•¸ ---
    const BOSS_BASE_HP = 80;
    const BOSS_HP_PER_LEVEL = 6;
    const BOSS_MAX_HP = 200;
    const BOSS_HITS_TO_WIN = 5;
    const BOSS_HEAL_FACTOR = 6;

    let bossMaxHP = 100;
    let bossDamage = 20;
    let bossHeal = 15;
    let currentBossHP = 100;
    let bossQuestions = [];
    let bossCurrentQ = null;
    let isBossBattle = false;
    let bossPending = false;
    let pendingMaterialDrop = null;
    let pendingMajicDrop = null;
    let selectedMaterial = null;
    let catSpeechTimer = null;

    function spawnParticles(x, y, emojis) {
        const count = 6;
        for (let i = 0; i < count; i += 1) {
            const el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'emoji-particle';
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;

            const angle = Math.random() * 360;
            const distance = 50 + Math.random() * 90;
            const tx = Math.cos(angle * Math.PI / 180) * distance;
            const ty = Math.sin(angle * Math.PI / 180) * distance;
            const rot = Math.floor(Math.random() * 720 - 360);

            el.style.setProperty('--tx', `${tx}px`);
            el.style.setProperty('--ty', `${ty}px`);
            el.style.setProperty('--rot', `${rot}deg`);

            document.body.appendChild(el);
            setTimeout(() => el.remove(), 900);
        }
    }

    function loadGame() {
        const saved = localStorage.getItem('catGameSave');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
            } catch(e) {}
        }
        if (!Array.isArray(gameState.inventory)) gameState.inventory = [];
        if (!Array.isArray(gameState.materialInventory)) gameState.materialInventory = [];
        if (!Array.isArray(gameState.synthUnlocked)) gameState.synthUnlocked = [0];
        if (typeof gameState.synthCurrent !== 'number') gameState.synthCurrent = 0;
        if (typeof gameState.synthHasNew !== 'boolean') gameState.synthHasNew = false;
        if (!Array.isArray(gameState.unlockedCats)) gameState.unlockedCats = [0];
        if (typeof gameState.currentCatIndex !== 'number') gameState.currentCatIndex = 0;
        if (!Array.isArray(gameState.geneMutations)) gameState.geneMutations = [];
        if (!Array.isArray(gameState.geneEyeMaterials)) gameState.geneEyeMaterials = GENE_EYES.slice(0, 3);
        if (!Array.isArray(gameState.geneMouthMaterials)) gameState.geneMouthMaterials = GENE_MOUTHS.slice(0, 3);
        if (typeof gameState.geneEyes !== 'string') gameState.geneEyes = GENE_EYES[0];
        if (typeof gameState.geneMouth !== 'string') gameState.geneMouth = GENE_MOUTHS[0];
        if (typeof gameState.geneHue !== 'number') gameState.geneHue = 0;
        if (typeof gameState.geneBlur !== 'number') gameState.geneBlur = 0;
        if (typeof gameState.geneActive !== 'boolean') gameState.geneActive = false;
        if (typeof gameState.geneName !== 'string') gameState.geneName = 'ç”œç”œå°å–µ #001';
        if (typeof gameState.geneDesc !== 'string') gameState.geneDesc = 'é–ƒé–ƒç™¼äº®ã€‚';
        if (gameState.geneCurrentId === undefined) gameState.geneCurrentId = null;
        if (!gameState.geneEyeMaterials.includes(gameState.geneEyes)) {
            gameState.geneEyeMaterials.push(gameState.geneEyes);
        }
        if (!gameState.geneMouthMaterials.includes(gameState.geneMouth)) {
            gameState.geneMouthMaterials.push(gameState.geneMouth);
        }
        if (!synthStyles[gameState.synthCurrent]) gameState.synthCurrent = 0;
        if (!gameState.synthUnlocked.includes(gameState.synthCurrent)) {
            gameState.synthUnlocked.push(gameState.synthCurrent);
        }
        if (gameState.musicOn === undefined) gameState.musicOn = true;
        gameState.level = Math.max(1, Math.floor(gameState.exp / EXP_PER_LEVEL) + 1);
        const levelIndex = clampCatIndex(gameState.level - 1);
        for (let i = 0; i <= levelIndex; i += 1) {
            if (!gameState.unlockedCats.includes(i)) gameState.unlockedCats.push(i);
        }
        if (!gameState.unlockedCats.includes(gameState.currentCatIndex)) {
            gameState.currentCatIndex = levelIndex;
        }
        gameState.currentCatIndex = clampCatIndex(gameState.currentCatIndex);
        updateRoomUI();
        renderSynthStyle(gameState.synthCurrent);
        applyGeneState();
    }

    function pickRandomBgmUrl() {
        if (!BGM_LIST.length) return "";
        const idx = Math.floor(Math.random() * BGM_LIST.length);
        return BGM_LIST[idx];
    }

    function pickRandom(list) {
        if (!list.length) return "";
        const idx = Math.floor(Math.random() * list.length);
        return list[idx];
    }

    function shuffle(list) {
        const copy = [...list];
        for (let i = copy.length - 1; i > 0; i -= 1) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
    }

    function getAllWords() {
        return Object.values(lessons)
            .filter((lesson) => !lesson.mode)
            .flatMap((lesson) => lesson.words);
    }

    function buildRandomWords(count) {
        const pool = shuffle(getAllWords());
        return pool.slice(0, count).map((word) => ({ ...word }));
    }

    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function buildStoryQuestions(count) {
        const templates = shuffle([
            () => {
                const price = randInt(6, 15);
                const qty = randInt(2, 9);
                return {
                    story: `åª½åª½è²·èœï¼Œæ¯é¡†è˜‹æœ ${price} å…ƒï¼Œè²·äº† ${qty} é¡†ï¼Œä¸€å…±å¤šå°‘å…ƒï¼Ÿ`,
                    answer: String(price * qty)
                };
            },
            () => {
                const kids = randInt(2, 8);
                const per = randInt(2, Math.min(8, Math.floor(50 / kids)));
                const candies = kids * per;
                return {
                    story: `æœ‰ ${candies} é¡†ç³–æœï¼Œå¹³å‡åˆ†çµ¦ ${kids} å€‹å°æœ‹å‹ï¼Œæ¯äººå¹¾é¡†ï¼Ÿ`,
                    answer: String(per)
                };
            },
            () => {
                const total = randInt(20, 50);
                const used = randInt(6, total - 6);
                return {
                    story: `å°æ˜æœ‰ ${total} å…ƒï¼Œè²·æ–‡å…·èŠ±äº† ${used} å…ƒï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ`,
                    answer: String(total - used)
                };
            },
            () => {
                const a = randInt(6, 25);
                const b = randInt(6, 25);
                return {
                    story: `ç±ƒå­è£¡æœ‰ ${a} é¡†æ©˜å­ï¼Œåˆæ”¾é€² ${b} é¡†ï¼Œä¸€å…±æœ‰å¹¾é¡†ï¼Ÿ`,
                    answer: String(a + b)
                };
            },
            () => {
                const per = randInt(2, 9);
                const days = randInt(2, 7);
                return {
                    story: `æ¯å¤©è®€ ${per} é ï¼Œé€£çºŒè®€ ${days} å¤©ï¼Œä¸€å…±è®€äº†å¹¾é ï¼Ÿ`,
                    answer: String(per * days)
                };
            }
        ]);
        const questions = [];
        for (let i = 0; i < count; i += 1) {
            const pick = templates[i % templates.length]();
            questions.push({
                type: "story",
                q: "æƒ…å¢ƒé¡Œ",
                a: pick.answer,
                r: "æ•¸å­¸é¡Œ",
                w: pick.story
            });
        }
        return questions;
    }

    function buildMathQuestions(count) {
        const storyCount = Math.min(5, count);
        const questions = buildStoryQuestions(storyCount);
        for (let i = storyCount; i < count; i += 1) {
            const useMultiply = Math.random() < 0.5;
            if (useMultiply) {
                const a = randInt(2, 9);
                const b = randInt(2, 9);
                questions.push({
                    type: "math",
                    q: `${a} Ã— ${b}`,
                    a: String(a * b),
                    r: "æ•¸å­¸é¡Œ",
                    w: `${a} Ã— ${b} = ${a * b}`
                });
            } else {
                const a = randInt(6, 44);
                const b = randInt(6, 50 - a);
                questions.push({
                    type: "math",
                    q: `${a} + ${b}`,
                    a: String(a + b),
                    r: "æ•¸å­¸é¡Œ",
                    w: `${a} + ${b} = ${a + b}`
                });
            }
        }
        return shuffle(questions);
    }

    function nextBgmUrl() {
        if (!BGM_LIST.length) return "";
        if (bgmQueue.length === 0) {
            bgmQueue = shuffle(BGM_LIST);
            if (bgmQueue.length > 1 && bgmQueue[0] === currentBgmUrl) {
                bgmQueue.push(bgmQueue.shift());
            }
        }
        return bgmQueue.shift();
    }

    function normalizeAudioSrc(path) {
        if (!path) return "";
        return path.startsWith("http") ? path : encodeURI(path);
    }

    function setRandomBgm(shouldPlay) {
        const bgm = document.getElementById('bgm');
        if (!bgm) return;
        let nextUrl = normalizeAudioSrc(nextBgmUrl());
        if (!nextUrl) return;
        if (bgm.src !== nextUrl) {
            bgm.src = nextUrl;
        }
        currentBgmUrl = nextUrl;
        bgm.load();
        if (shouldPlay && gameState.musicOn) {
            bgm.volume = 0.2;
            bgm.play().catch(() => {});
        }
    }

    function saveGame() {
        localStorage.setItem('catGameSave', JSON.stringify(gameState));
        updateRoomUI();
    }

    function updateRoomUI() {
        // å®‰å…¨æª¢æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨å ±éŒ¯
        const uiLevel = document.getElementById('ui-level');
        const uiFood = document.getElementById('ui-food');
        const uiExpText = document.getElementById('ui-exp-text');
        const uiExpBar = document.getElementById('ui-exp-bar');
        const catImg = document.getElementById('cat-image');

        if (uiLevel) uiLevel.innerText = gameState.level;
        if (uiFood) uiFood.innerText = gameState.food;
        
        const currentExp = gameState.exp % EXP_PER_LEVEL;
        const pct = (currentExp / EXP_PER_LEVEL) * 100;

        if (gameState.level > catSprites.length) {
            if (uiExpText) uiExpText.innerText = "MAX";
            if (uiExpBar) uiExpBar.style.width = "100%";
        } else {
            if (uiExpText) uiExpText.innerText = `${currentExp}/${EXP_PER_LEVEL}`;
            if (uiExpBar) uiExpBar.style.width = `${pct}%`;
        }

        const levelIndex = clampCatIndex(gameState.level - 1);
        if (!gameState.unlockedCats.includes(levelIndex)) {
            unlockCatSkin(levelIndex, false);
        }
        const currentIndex = clampCatIndex(
            typeof gameState.currentCatIndex === 'number' ? gameState.currentCatIndex : levelIndex
        );
        if (catImg) catImg.src = catSprites[currentIndex];

        shopItems.forEach((item) => {
            const el = document.getElementById(item.id);
            if (!el) return;
            if (gameState.inventory.includes(item.id)) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });

        const shopFood = document.getElementById('shop-food-display');
        if (shopFood) shopFood.innerText = gameState.food;

        const synthBadge = document.getElementById('synth-badge');
        if (synthBadge) {
            if (gameState.synthHasNew) synthBadge.classList.remove('hidden');
            else synthBadge.classList.add('hidden');
        }

        renderSynthStyle(gameState.synthCurrent);
        applyGeneState();
    }

    // --- éŸ³æ•ˆæ’­æ”¾ (å«å®‰å…¨æ©Ÿåˆ¶) ---
    function playSound(id) {
        try {
            const audio = document.getElementById(id);
            if (audio) {
                audio.muted = false;
                audio.currentTime = 0;
                audio.volume = 0.5;
                const promise = audio.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.log("Sound play error (safe):", id);
                    });
                }
            }
        } catch(e) {
            console.log("Audio Element missing or error");
        }
    }

    function unlockAudioAndStart() {
        // å˜—è©¦è§£é–æ‰€æœ‰éŸ³æ•ˆ
        const audios = ['bgm', 'sfx-correct', 'sfx-wrong', 'sfx-meow', 'sfx-levelup', 'sfx-chew', 'sfx-flip', 'sfx-angry', 'sfx-win', 'sfx-real-meow', 'sfx-boss-bgm', 'sfx-boss-hit', 'sfx-boss-heal', 'sfx-boss-appear'];
        audios.forEach(id => {
            try {
                const el = document.getElementById(id);
                if(el) {
                    if (id === 'bgm' && !el.src) setRandomBgm(true);
                    el.muted = true;
                    el.load();
                    const playPromise = el.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            el.pause();
                            el.currentTime = 0;
                            el.muted = false;
                            if(id === 'bgm' && gameState.musicOn) {
                                el.volume = 0.2;
                                el.play().catch(() => {});
                            }
                        }).catch(() => {
                            el.muted = false;
                        });
                    } else {
                        el.muted = false;
                        if(id === 'bgm' && gameState.musicOn) {
                            el.volume = 0.2;
                            el.play().catch(() => {});
                        }
                    }
                }
            } catch(e) {}
        });

        // è§£é–èªéŸ³
        try {
            const synth = window.speechSynthesis;
            const utter = new SpeechSynthesisUtterance('');
            synth.speak(utter);
        } catch(e) {}

        document.getElementById('start-screen').style.display = 'none';
        const room = document.getElementById('scene-room');
        room.classList.remove('hidden');
        setTimeout(() => room.classList.remove('opacity-0'), 50);
    }

    // --- 2. è²“å’ªäº’å‹• ---
    function petCat(e) {
        e.stopPropagation();
        
        const isHappy = Math.random() > 0.3;
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX || (rect.left + rect.width/2);
        const y = e.clientY || (rect.top + rect.height/2);
        
        const icon = document.createElement('div');
        icon.className = 'float-icon';
        icon.style.left = (x - rect.left) + 'px';
        icon.style.top = (y - rect.top) + 'px';

        const catContainer = document.getElementById('cat-container');
        
        if (isHappy) {
            try {
                const happyUrl = normalizeAudioSrc(pickRandom(HAPPY_MEOW_LIST));
                const realMeow = document.getElementById('sfx-real-meow');
                if (realMeow && happyUrl) {
                    realMeow.src = happyUrl;
                    realMeow.load();
                    realMeow.currentTime = 0;
                    realMeow.play().catch(() => playSound('sfx-meow'));
                } else {
                    playSound('sfx-meow');
                }
            } catch(e) {
                playSound('sfx-meow');
            }

            icon.innerText = "â¤ï¸";
            icon.style.color = "#ff4757";
            catContainer.classList.remove('cat-angry');
            spawnParticles(x, y, ['â¤ï¸', 'ğŸ˜»', 'ğŸ¾']);
            if (Math.random() < 0.12) {
                spawnParticles(x, y, ['âœ¨', 'ğŸ€', 'ğŸ']);
                showCatSpeech();
            }
        } else {
            try {
                const angryUrl = normalizeAudioSrc(pickRandom(ANGRY_MEOW_LIST));
                const angryMeow = document.getElementById('sfx-angry');
                if (angryMeow && angryUrl) {
                    angryMeow.src = angryUrl;
                    angryMeow.load();
                    angryMeow.currentTime = 0;
                    angryMeow.play().catch(() => playSound('sfx-angry'));
                } else {
                    playSound('sfx-angry');
                }
            } catch(e) {
                playSound('sfx-angry');
            }
            icon.innerText = "ğŸ’¢";
            icon.style.color = "#2f3542";
            catContainer.classList.remove('cat-angry'); 
            void catContainer.offsetWidth; 
            catContainer.classList.add('cat-angry');
            spawnParticles(x, y, ['ğŸ’¢', 'âš¡', 'ğŸ™€']);
            showCatSpeech();
        }

        catContainer.appendChild(icon);
        setTimeout(() => icon.remove(), 1000);
    }

    function feedCat(e) {
        if (gameState.food <= 0) {
            alert("ç½é ­ä¸å¤ äº†ï¼å¿«å»ã€Œå»æ‰“å·¥ã€è³ºç½é ­å§ï¼");
            return;
        }

        gameState.food--;
        gameState.exp += 1;
        playSound('sfx-chew');

        const rect = e?.target?.getBoundingClientRect();
        const x = rect ? rect.left + rect.width / 2 : window.innerWidth / 2;
        const y = rect ? rect.top : window.innerHeight / 2;
        spawnParticles(x, y, ['ğŸŸ', 'ğŸ˜‹', 'âœ¨']);
        
        const calculatedLevel = Math.floor(gameState.exp / EXP_PER_LEVEL) + 1;
        
        if (calculatedLevel > gameState.level) {
            gameState.level = calculatedLevel;
            unlockCatSkin(calculatedLevel - 1, true);
            showLevelUp();
        }

        saveGame();
    }

    function showLevelUp() {
        playSound('sfx-levelup');
        const overlay = document.getElementById('levelup-overlay');
        overlay.classList.remove('hidden');
        setTimeout(() => {
            overlay.classList.add('hidden');
        }, 3000);
    }

    // --- å•†åº—ç³»çµ± ---
    function openShop() {
        const shop = document.getElementById('scene-shop');
        if (shop) shop.classList.remove('hidden');
        renderShop();
        playSound('sfx-flip');
    }

    function closeShop() {
        const shop = document.getElementById('scene-shop');
        if (shop) shop.classList.add('hidden');
    }

    function renderShop() {
        const list = document.getElementById('shop-list');
        const foodDisplay = document.getElementById('shop-food-display');
        if (!list || !foodDisplay) return;
        foodDisplay.innerText = gameState.food;
        list.innerHTML = '';

        shopItems.forEach((item) => {
            const isOwned = gameState.inventory.includes(item.id);
            const canAfford = gameState.food >= item.price;
            const row = document.createElement('div');
            row.className = `flex items-center justify-between p-3 rounded-xl border-2 ${isOwned ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`;

            const buttonHtml = isOwned
                ? '<span class="px-4 py-2 bg-gray-200 text-gray-500 rounded-lg font-bold text-sm">å·²æ“æœ‰</span>'
                : `<button onclick="buyItem('${item.id}', ${item.price}, event)" class="px-4 py-2 rounded-lg font-bold text-sm transition btn-3d border-b-4 ${canAfford ? 'bg-purple-500 text-white border-purple-700 hover:bg-purple-600' : 'bg-gray-300 text-gray-500 border-gray-400 cursor-not-allowed'}" ${canAfford ? '' : 'disabled'}>ğŸ’° ${item.price}</button>`;

            row.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-4xl bg-white p-2 rounded-lg shadow-sm">${item.icon}</div>
                    <div>
                        <h3 class="font-bold text-gray-800">${item.name}</h3>
                        <p class="text-xs text-gray-500">${item.desc}</p>
                    </div>
                </div>
                ${buttonHtml}
            `;
            list.appendChild(row);
        });
    }

    function buyItem(itemId, price, evt) {
        if (gameState.inventory.includes(itemId)) return;
        if (gameState.food < price) {
            playSound('sfx-wrong');
            return;
        }

        gameState.food -= price;
        gameState.inventory.push(itemId);
        saveGame();
        renderShop();
        playSound('sfx-correct');

        const rect = evt?.target?.getBoundingClientRect();
        const x = rect ? rect.left + rect.width / 2 : window.innerWidth / 2;
        const y = rect ? rect.top : window.innerHeight / 2;
        spawnParticles(x, y, ['ğŸ‰', 'ğŸ’°', 'âœ¨']);
    }

    // --- åˆæˆç³»çµ± ---
    function getMaterialById(id) {
        return synthMaterials.find((item) => item.id === id);
    }

    function getSynthStyle(id) {
        return synthStyles[id] || synthStyles[0];
    }

    function setCatFilter(filterClass) {
        const catImg = document.getElementById('cat-image');
        if (!catImg) return;
        const filterClasses = ['cat-filter-ice', 'cat-filter-shadow', 'cat-filter-fire', 'cat-filter-stone'];
        catImg.classList.remove(...filterClasses);
        if (filterClass) catImg.classList.add(filterClass);
    }

    function renderSynthStyle(styleId, targetId = 'synth-stack') {
        const style = getSynthStyle(styleId);
        const container = document.getElementById(targetId);
        if (!container) return;

        if (targetId === 'synth-stack') {
            setCatFilter(style.catFilter);
        }

        container.innerHTML = '';
        if (!style.layers || style.layers.length === 0) return;

        style.layers.forEach((layer) => {
            const el = document.createElement('div');
            el.className = 'synth-layer';
            if (layer.anim) el.classList.add(layer.anim);
            if (layer.className) el.classList.add(layer.className);
            el.innerText = layer.icon;
            if (layer.size) el.style.fontSize = `${layer.size}rem`;
            if (layer.left !== undefined) el.style.left = `${layer.left}%`;
            if (layer.top !== undefined) el.style.top = `${layer.top}%`;
            if (layer.z !== undefined) el.style.zIndex = layer.z;
            if (layer.opacity !== undefined) el.style.opacity = layer.opacity;
            const transforms = ['translate(-50%, -50%)'];
            if (layer.rotate) transforms.push(`rotate(${layer.rotate}deg)`);
            if (layer.scale) transforms.push(`scale(${layer.scale})`);
            el.style.transform = transforms.join(' ');
            container.appendChild(el);
        });
    }

    let geneLabReady = false;

    function initGeneLab() {
        const firstInit = !geneLabReady;
        geneLabReady = true;
        renderGeneButtons('gene-eyes-panel', GENE_EYES, 'eyes');
        renderGeneButtons('gene-mouth-panel', GENE_MOUTHS, 'mouth');
        if (firstInit) {
            const hueSlider = document.getElementById('gene-hue-slider');
            const blurSlider = document.getElementById('gene-blur-slider');
            if (hueSlider) hueSlider.addEventListener('input', updateGeneFilters);
            if (blurSlider) blurSlider.addEventListener('input', updateGeneFilters);
        }
    }

    function renderGeneButtons(containerId, list, type) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        const ownedList = (type === 'eyes' ? gameState.geneEyeMaterials : gameState.geneMouthMaterials) || [];
        list.forEach((emoji) => {
            const btn = document.createElement('button');
            const owned = ownedList.includes(emoji);
            btn.className = `gene-btn${owned ? '' : ' locked'}`;
            btn.dataset.emoji = emoji;
            btn.textContent = owned ? emoji : 'ğŸ”’';
            btn.disabled = !owned;
            if (owned) btn.onclick = () => setGenePart(type, emoji);
            container.appendChild(btn);
        });
    }

    function setGenePart(type, emoji) {
        const ownedList = (type === 'eyes' ? gameState.geneEyeMaterials : gameState.geneMouthMaterials) || [];
        if (!ownedList.includes(emoji)) return;
        if (type === 'eyes') {
            gameState.geneEyes = emoji;
        } else {
            gameState.geneMouth = emoji;
        }
        gameState.geneActive = true;
        gameState.geneCurrentId = null;
        updateGeneProfile();
        applyGeneState();
        syncGeneControls();
        saveGame();
    }

    function updateGeneProfile() {
        const adj = pickRandom(GENE_ADJECTIVES);
        const noun = pickRandom(GENE_NOUNS);
        const code = randInt(10, 999);
        gameState.geneName = `${adj}${noun} #${code}`;
        gameState.geneDesc = pickRandom(GENE_DESCS);
    }

    function updateGeneFilters() {
        const hueSlider = document.getElementById('gene-hue-slider');
        const blurSlider = document.getElementById('gene-blur-slider');
        const hue = hueSlider ? Number(hueSlider.value) : 0;
        const blur = blurSlider ? Number(blurSlider.value) : 0;
        gameState.geneHue = hue;
        gameState.geneBlur = blur;
        gameState.geneActive = true;
        gameState.geneCurrentId = null;
        applyGeneState();
        syncGeneControls();
        saveGame();
    }

    function applyGeneState() {
        const overlay = document.getElementById('gene-overlay');
        const eyeL = document.getElementById('gene-eye-l');
        const eyeR = document.getElementById('gene-eye-r');
        const mouth = document.getElementById('gene-mouth');
        if (!overlay || !eyeL || !eyeR || !mouth) return;

        if (!gameState.geneActive) {
            overlay.classList.add('hidden');
            overlay.style.filter = '';
            return;
        }

        overlay.classList.remove('hidden');
        eyeL.textContent = gameState.geneEyes;
        eyeR.textContent = gameState.geneEyes;
        mouth.textContent = gameState.geneMouth;
        overlay.style.filter = `hue-rotate(${gameState.geneHue}deg) blur(${gameState.geneBlur}px)`;
    }

    function syncGeneControls() {
        renderGeneButtons('gene-eyes-panel', GENE_EYES, 'eyes');
        renderGeneButtons('gene-mouth-panel', GENE_MOUTHS, 'mouth');
        highlightGeneButtons('gene-eyes-panel', gameState.geneEyes);
        highlightGeneButtons('gene-mouth-panel', gameState.geneMouth);
        const hueVal = document.getElementById('gene-hue-val');
        const blurVal = document.getElementById('gene-blur-val');
        const hueSlider = document.getElementById('gene-hue-slider');
        const blurSlider = document.getElementById('gene-blur-slider');
        if (hueSlider) hueSlider.value = gameState.geneHue;
        if (blurSlider) blurSlider.value = gameState.geneBlur;
        if (hueVal) hueVal.textContent = `${gameState.geneHue}Â°`;
        if (blurVal) blurVal.textContent = `${gameState.geneBlur}`;

        const nameEl = document.getElementById('gene-name');
        const descEl = document.getElementById('gene-desc');
        if (nameEl) nameEl.textContent = gameState.geneName;
        if (descEl) descEl.textContent = gameState.geneDesc;
    }

    function highlightGeneButtons(panelId, emoji) {
        const panel = document.getElementById(panelId);
        if (!panel) return;
        Array.from(panel.children).forEach((btn) => {
            if (btn.dataset.emoji === emoji) btn.classList.add('selected');
            else btn.classList.remove('selected');
        });
    }

    function randomGeneMutation() {
        const eyePool = gameState.geneEyeMaterials.length ? gameState.geneEyeMaterials : GENE_EYES;
        const mouthPool = gameState.geneMouthMaterials.length ? gameState.geneMouthMaterials : GENE_MOUTHS;
        gameState.geneEyes = pickRandom(eyePool);
        gameState.geneMouth = pickRandom(mouthPool);
        gameState.geneHue = randInt(0, 360);
        gameState.geneBlur = Number((Math.random() * 2).toFixed(1));
        gameState.geneActive = true;
        gameState.geneCurrentId = null;
        updateGeneProfile();
        applyGeneState();
        syncGeneControls();
        spawnParticles(window.innerWidth / 2, window.innerHeight / 2, ['âœ¨', 'ğŸ’«', 'ğŸ‰']);
        playSound('sfx-flip');
        saveGame();
    }

    function saveGeneMutation() {
        if (!gameState.geneActive) {
            return;
        }
        const mutation = {
            id: String(Date.now()),
            name: gameState.geneName,
            desc: gameState.geneDesc,
            eyes: gameState.geneEyes,
            mouth: gameState.geneMouth,
            hue: gameState.geneHue,
            blur: gameState.geneBlur
        };
        gameState.geneMutations.unshift(mutation);
        gameState.geneCurrentId = mutation.id;
        saveGame();
        renderGeneCollection();
        spawnParticles(window.innerWidth / 2, window.innerHeight / 2, ['ğŸ’¾', 'âœ¨', 'ğŸ‰']);
        playSound('sfx-levelup');
    }

    function applyGeneMutation(mutation) {
        if (!gameState.geneEyeMaterials.includes(mutation.eyes)) {
            gameState.geneEyeMaterials.push(mutation.eyes);
        }
        if (!gameState.geneMouthMaterials.includes(mutation.mouth)) {
            gameState.geneMouthMaterials.push(mutation.mouth);
        }
        gameState.geneEyes = mutation.eyes;
        gameState.geneMouth = mutation.mouth;
        gameState.geneHue = mutation.hue;
        gameState.geneBlur = mutation.blur;
        gameState.geneName = mutation.name;
        gameState.geneDesc = mutation.desc;
        gameState.geneCurrentId = mutation.id;
        gameState.geneActive = true;
        applyGeneState();
        syncGeneControls();
        saveGame();
    }

    function resetGeneMutation() {
        gameState.geneActive = false;
        gameState.geneCurrentId = null;
        gameState.geneEyes = gameState.geneEyeMaterials[0] || GENE_EYES[0];
        gameState.geneMouth = gameState.geneMouthMaterials[0] || GENE_MOUTHS[0];
        gameState.geneHue = 0;
        gameState.geneBlur = 0;
        gameState.geneName = 'ç”œç”œå°å–µ #001';
        gameState.geneDesc = 'é–ƒé–ƒç™¼äº®ã€‚';
        applyGeneState();
        syncGeneControls();
        saveGame();
    }

    function renderGeneCollection() {
        const list = document.getElementById('gene-collection-list');
        if (!list) return;
        list.innerHTML = '';
        if (!gameState.geneMutations.length) {
            list.innerHTML = '<p class="col-span-2 text-center text-gray-400 text-xs py-3">é‚„æ²’æœ‰æ”¶è—çš„é­”æ³•é€ å‹ã€‚</p>';
            return;
        }

        gameState.geneMutations.forEach((mutation) => {
            const isActive = gameState.geneCurrentId === mutation.id;
            const card = document.createElement('button');
            card.className = `p-2 rounded-xl border-2 flex flex-col items-center gap-1 transition ${isActive ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 bg-white hover:border-indigo-300'}`;
            card.innerHTML = `
                <div class="text-2xl">${mutation.eyes}${mutation.mouth}</div>
                <div class="text-[10px] font-bold text-center">${mutation.name}</div>
            `;
            card.onclick = () => applyGeneMutation(mutation);
            list.appendChild(card);
        });
    }

    function openSynthesis() {
        const panel = document.getElementById('scene-synthesis');
        if (panel) panel.classList.remove('hidden');
        gameState.synthHasNew = false;
        saveGame();
        resetCraftSlot();
        switchSynthesisTab('synth-tab-craft');
        renderSynthStyle(gameState.synthCurrent, 'synth-preview');
        playSound('sfx-flip');
    }

    function closeSynthesis() {
        const panel = document.getElementById('scene-synthesis');
        if (panel) panel.classList.add('hidden');
        resetCraftSlot();
    }

    function openCatBook() {
        const panel = document.getElementById('scene-catbook');
        if (panel) panel.classList.remove('hidden');
        renderCatBook();
        playSound('sfx-flip');
    }

    function closeCatBook() {
        const panel = document.getElementById('scene-catbook');
        if (panel) panel.classList.add('hidden');
    }

    function summonCat(index) {
        const safeIndex = clampCatIndex(index);
        if (!gameState.unlockedCats.includes(safeIndex)) return;
        gameState.currentCatIndex = safeIndex;
        saveGame();
        updateRoomUI();
        playSound('sfx-flip');
    }

    function renderCatBook() {
        const list = document.getElementById('catbook-list');
        const progress = document.getElementById('catbook-progress');
        if (!list || !progress) return;
        list.innerHTML = '';

        const total = catSprites.length;
        const unlocked = gameState.unlockedCats.length;
        progress.innerText = `${unlocked}/${total}`;

        for (let i = 0; i < total; i += 1) {
            const isUnlocked = gameState.unlockedCats.includes(i);
            const isEquipped = gameState.currentCatIndex === i;
            const card = document.createElement('button');
            let className = 'aspect-square rounded-2xl border-2 flex flex-col items-center justify-center relative transition-all duration-200 select-none ';
            if (isUnlocked) {
                className += 'bg-white cursor-pointer hover:scale-105 hover:shadow-md hover:border-amber-300 ';
                className += isEquipped ? 'border-green-500 bg-green-50 ring-2 ring-green-100 z-10' : 'border-amber-100 text-gray-600';
            } else {
                className += 'bg-gray-200 border-gray-300 opacity-60 cursor-not-allowed';
            }
            card.className = className;

            if (isUnlocked) {
                const badge = isEquipped
                    ? '<div class="absolute -top-2 -right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm border border-white">ä½¿ç”¨ä¸­</div>'
                    : '';
                card.innerHTML = `
                    ${badge}
                    <img src="${catSprites[i]}" alt="Cat ${i + 1}" class="w-16 h-16 object-contain drop-shadow-sm" loading="lazy">
                    <div class="text-[10px] font-bold text-center text-gray-600 mt-1">Lv.${i + 1}</div>
                `;
                card.onclick = () => {
                    summonCat(i);
                    renderCatBook();
                };
            } else {
                card.innerHTML = `
                    <div class="text-2xl grayscale mb-1">ğŸ”’</div>
                    <div class="text-[10px] font-bold text-gray-400">???</div>
                `;
            }
            list.appendChild(card);
        }
    }

    function switchSynthesisTab(tabId) {
        const craft = document.getElementById('synth-tab-craft');
        const collection = document.getElementById('synth-tab-collection');
        const gene = document.getElementById('synth-tab-gene');
        if (!craft || !collection || !gene) return;
        craft.classList.add('hidden');
        collection.classList.add('hidden');
        gene.classList.add('hidden');
        document.getElementById(tabId).classList.remove('hidden');

        const btnCraft = document.getElementById('btn-synth-tab-craft');
        const btnCollection = document.getElementById('btn-synth-tab-collection');
        const btnGene = document.getElementById('btn-synth-tab-gene');
        if (tabId === 'synth-tab-craft') {
            btnCraft.className = 'flex-1 py-2 rounded-md font-bold text-sm bg-white shadow-sm text-indigo-600 transition';
            btnCollection.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            btnGene.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            renderMaterialInventory();
        } else if (tabId === 'synth-tab-collection') {
            btnCollection.className = 'flex-1 py-2 rounded-md font-bold text-sm bg-white shadow-sm text-indigo-600 transition';
            btnCraft.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            btnGene.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            renderWardrobe();
        } else {
            btnGene.className = 'flex-1 py-2 rounded-md font-bold text-sm bg-white shadow-sm text-indigo-600 transition';
            btnCraft.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            btnCollection.className = 'flex-1 py-2 rounded-md font-bold text-sm text-gray-400 hover:bg-white/50 transition';
            initGeneLab();
            syncGeneControls();
            renderGeneCollection();
        }
    }

    function renderMaterialInventory() {
        const list = document.getElementById('material-list');
        const msg = document.getElementById('synth-msg');
        if (!list) return;
        list.innerHTML = '';

        const counts = {};
        gameState.materialInventory.forEach((id) => {
            counts[id] = (counts[id] || 0) + 1;
        });
        const ids = Object.keys(counts);
        if (ids.length === 0) {
            list.innerHTML = '<p class="col-span-4 text-center text-gray-400 text-sm py-4">æ²’æœ‰ç´ æï¼Œæ‰“å·¥æˆ–æ‰“é­”ç‹å¯ç²å¾—ã€‚</p>';
            if (msg) msg.innerText = '';
            return;
        }

        ids.forEach((id) => {
            const item = getMaterialById(id);
            if (!item) return;
            const button = document.createElement('button');
            button.className = 'relative aspect-square border-2 border-gray-200 rounded-xl flex items-center justify-center text-3xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-300 transition bg-white';
            button.innerText = item.icon;
            button.onclick = () => selectMaterial(item);

            const count = document.createElement('span');
            count.className = 'absolute -bottom-1 -right-1 bg-gray-800 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center';
            count.innerText = counts[id];
            button.appendChild(count);
            list.appendChild(button);
        });
    }

    function selectMaterial(item) {
        selectedMaterial = item;
        const slot = document.getElementById('craft-slot');
        if (slot) {
            slot.innerText = item.icon;
            slot.classList.add('border-indigo-500', 'bg-indigo-100');
        }
        const btn = document.getElementById('btn-synthesize');
        if (btn) {
            btn.disabled = false;
            btn.className = 'px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-md btn-3d border-b-4 border-indigo-800 active:border-indigo-600';
            btn.innerText = 'âœ¨ é–‹å§‹åˆæˆ';
        }
        const previewId = item.styleId || 0;
        renderSynthStyle(previewId, 'synth-preview');
        playSound('sfx-flip');
    }

    function resetCraftSlot() {
        selectedMaterial = null;
        const slot = document.getElementById('craft-slot');
        if (slot) {
            slot.innerText = 'â“';
            slot.className = 'w-16 h-16 border-2 border-dashed border-indigo-300 rounded-xl flex items-center justify-center text-4xl bg-white cursor-pointer';
        }
        const btn = document.getElementById('btn-synthesize');
        if (btn) {
            btn.disabled = true;
            btn.className = 'px-4 py-2 bg-gray-300 text-white rounded-lg font-bold shadow-sm';
            btn.innerText = 'åˆæˆ';
        }
        const msg = document.getElementById('synth-msg');
        if (msg) msg.innerText = '';
        renderSynthStyle(gameState.synthCurrent, 'synth-preview');
    }

    function doSynthesis() {
        const msg = document.getElementById('synth-msg');
        if (!selectedMaterial) return;
        const resultId = selectedMaterial.styleId;
        if (!resultId) {
            if (msg) msg.innerText = 'ç´ æç„¡æ³•åˆæˆæ–°çš„é€ å‹ã€‚';
            playSound('sfx-wrong');
            return;
        }

        if (!gameState.synthUnlocked.includes(resultId)) {
            gameState.synthUnlocked.push(resultId);
            gameState.synthCurrent = resultId;
            const idx = gameState.materialInventory.indexOf(selectedMaterial.id);
            if (idx >= 0) gameState.materialInventory.splice(idx, 1);
            saveGame();
            renderSynthStyle(resultId);
            if (msg) msg.innerText = `âœ¨ åˆæˆæˆåŠŸï¼ç²å¾—ã€Œ${getSynthStyle(resultId).name}ã€`;
            spawnParticles(window.innerWidth / 2, window.innerHeight / 2, ['âœ¨', 'ğŸ‰', 'ğŸ”®']);
            playSound('sfx-levelup');
            renderMaterialInventory();
            renderWardrobe();
        } else {
            gameState.synthCurrent = resultId;
            saveGame();
            renderSynthStyle(resultId);
            if (msg) msg.innerText = 'å·²æ“æœ‰è©²é€ å‹ï¼Œå·²å¹«ä½ æ›è£ã€‚';
            playSound('sfx-flip');
        }
    }

    function renderWardrobe() {
        const list = document.getElementById('synth-tab-collection');
        if (!list) return;
        list.innerHTML = '';
        gameState.synthUnlocked.forEach((styleId) => {
            const style = getSynthStyle(styleId);
            const isCurrent = gameState.synthCurrent === styleId;
            const card = document.createElement('button');
            card.className = `p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition ${isCurrent ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white hover:border-indigo-300'}`;
            const icon = style.layers && style.layers.length > 0 ? style.layers[0].icon : 'ğŸ±';
            card.innerHTML = `
                <div class="text-4xl">${icon}</div>
                <div class="text-xs font-bold text-center">${style.name}</div>
            `;
            card.onclick = () => {
                gameState.synthCurrent = styleId;
                saveGame();
                renderSynthStyle(styleId);
                renderWardrobe();
                playSound('sfx-flip');
            };
            list.appendChild(card);
        });
    }

    // --- 3. å­¸ç¿’ç³»çµ± ---
    let studyQueue = [];
    let currentCardIndex = 0;
    
    function openMenu() {
        document.getElementById('scene-menu').classList.remove('hidden');
        const list = document.getElementById('lesson-list');
        list.innerHTML = '';
        
        for (let k in lessons) {
            const btn = document.createElement('button');
            btn.className = "btn-3d p-4 bg-yellow-100 rounded-xl font-bold hover:bg-yellow-200 border-b-4 border-yellow-300 text-lg flex items-center justify-between";
            btn.innerHTML = `<span>ğŸ“š ${lessons[k].title}</span> <span class="text-sm bg-yellow-300 px-2 py-1 rounded-full text-yellow-800">${lessons[k].words.length}å­—</span>`;
            btn.onclick = () => startLevel(k);
            list.appendChild(btn);
        }
    }

    function closeMenu() {
        document.getElementById('scene-menu').classList.add('hidden');
    }

    function startLevel(key) {
        closeMenu();
        bossPending = false;
        isBossBattle = false;
        const lesson = lessons[key];
        if (lesson && lesson.mode === "random10") {
            studyQueue = buildRandomWords(10);
        } else if (lesson && lesson.mode === "math10") {
            studyQueue = buildMathQuestions(10);
        } else {
            studyQueue = [...lesson.words].sort(() => Math.random() - 0.5);
        }
        currentCardIndex = 0;
        document.getElementById('scene-study').classList.remove('hidden');
        loadCard();
    }

    function quitStudy() {
        document.getElementById('scene-study').classList.add('hidden');
        document.getElementById('scene-boss').classList.add('hidden');
        isBossBattle = false;
        bossPending = false;
        stopBossBgm();
        resumeRoomBgm();
        window.speechSynthesis.cancel();
    }

    function pauseRoomBgm() {
        const bgm = document.getElementById('bgm');
        if (bgm) bgm.pause();
    }

    function resumeRoomBgm() {
        const bgm = document.getElementById('bgm');
        if (bgm && gameState.musicOn) bgm.play().catch(() => {});
    }

    function startBossBgm() {
        const bossBgm = document.getElementById('sfx-boss-bgm');
        if (!bossBgm || !gameState.musicOn) return;
        bossBgm.volume = 0.3;
        bossBgm.currentTime = 0;
        bossBgm.play().catch(() => {});
    }

    function stopBossBgm() {
        const bossBgm = document.getElementById('sfx-boss-bgm');
        if (bossBgm) {
            bossBgm.pause();
            bossBgm.currentTime = 0;
        }
        bossBgmWasPlaying = false;
    }

    // --- é­”ç‹æˆ°ç³»çµ± ---
    function prepareBossStats() {
        bossMaxHP = Math.min(BOSS_MAX_HP, BOSS_BASE_HP + (gameState.level - 1) * BOSS_HP_PER_LEVEL);
        bossDamage = Math.max(12, Math.ceil(bossMaxHP / BOSS_HITS_TO_WIN));
        bossHeal = Math.max(10, Math.ceil(bossMaxHP / BOSS_HEAL_FACTOR));
        currentBossHP = bossMaxHP;
    }

    function triggerBossEvent() {
        pauseRoomBgm();
        playSound('sfx-boss-appear');
        setTimeout(startBossBgm, 900);

        isBossBattle = true;
        bossPending = false;
        prepareBossStats();

        const basePool = studyQueue.length ? [...studyQueue] : buildRandomWords(10);
        const extraPool = buildRandomWords(8);
        bossQuestions = shuffle([...basePool, ...extraPool]);

        document.getElementById('scene-study').classList.add('hidden');
        document.getElementById('scene-boss').classList.remove('hidden');

        const randomSeed = Math.floor(Math.random() * 10000);
        document.getElementById('boss-image').src = `https://robohash.org/${randomSeed}?set=set2&size=300x300`;

        updateBossUI();
        loadBossQuestion();
    }

    function updateBossUI() {
        const pct = Math.max(0, Math.min(100, (currentBossHP / bossMaxHP) * 100));
        document.getElementById('boss-hp-bar').style.width = `${pct}%`;
        document.getElementById('boss-hp-text').innerText = currentBossHP;
        document.getElementById('boss-hp-max').innerText = bossMaxHP;
    }

    function loadBossQuestion() {
        if (bossQuestions.length === 0) {
            bossQuestions = buildRandomWords(5);
        }
        bossCurrentQ = bossQuestions.shift();

        document.getElementById('boss-answer-mask').classList.remove('hidden');
        document.getElementById('boss-answer-area').classList.add('hidden');

        const isMath = bossCurrentQ.type === "math";
        const isStory = bossCurrentQ.type === "story";
        const qText = isMath ? bossCurrentQ.q : isStory ? "æƒ…å¢ƒé¡Œ" : bossCurrentQ.z;
        const wText = isStory ? bossCurrentQ.w : isMath ? "" : bossCurrentQ.w.split(bossCurrentQ.c).join("ï¼¿");

        document.getElementById('boss-q-zhuyin').innerText = qText;
        document.getElementById('boss-q-word').innerText = wText;
        document.getElementById('boss-a-char').innerText = (isMath || isStory) ? bossCurrentQ.a : bossCurrentQ.c;

        speak("æ”»æ“Šæº–å‚™ï¼" + (isStory ? bossCurrentQ.w : isMath ? bossCurrentQ.q : bossCurrentQ.w));
    }

    function revealBossAnswer() {
        document.getElementById('boss-answer-mask').classList.add('hidden');
        document.getElementById('boss-answer-area').classList.remove('hidden');
        const isMath = bossCurrentQ.type === "math";
        const isStory = bossCurrentQ.type === "story";
        const ans = (isMath || isStory) ? bossCurrentQ.a : bossCurrentQ.c;
        playSound('sfx-flip');
        speak(ans);
    }

    function attackBoss(isCorrect) {
        const bossImg = document.getElementById('boss-image');
        if (isCorrect) {
            playSound('sfx-boss-hit');
            currentBossHP = Math.max(0, currentBossHP - bossDamage);
            bossImg.classList.remove('boss-damage', 'boss-heal');
            void bossImg.offsetWidth;
            bossImg.classList.add('boss-damage');
            showBossEffect(`-${bossDamage}`, "text-red-500");
        } else {
            playSound('sfx-boss-heal');
            currentBossHP = Math.min(bossMaxHP, currentBossHP + bossHeal);
            bossImg.classList.remove('boss-damage', 'boss-heal');
            void bossImg.offsetWidth;
            bossImg.classList.add('boss-heal');
            showBossEffect(`+${bossHeal}`, "text-green-400");
        }

        updateBossUI();

        if (currentBossHP <= 0) {
            setTimeout(() => {
                isBossBattle = false;
                stopBossBgm();
                document.getElementById('scene-boss').classList.add('hidden');
                finishLevel(true);
            }, 800);
        } else {
            setTimeout(loadBossQuestion, 900);
        }
    }

    function showBossEffect(text, colorClass) {
        const ef = document.getElementById('boss-effect');
        ef.innerText = text;
        ef.className = `absolute text-6xl font-bold transition-all ${colorClass}`;
        ef.style.opacity = 1;
        ef.style.top = "20%";

        setTimeout(() => {
            ef.style.top = "10%";
            ef.style.opacity = 0;
        }, 800);
    }

    function pickMaterialDrop(isBossWin) {
        const pool = isBossWin
            ? synthMaterials.filter((item) => item.rare)
            : synthMaterials;
        if (!pool.length) return null;
        if (!isBossWin && Math.random() > 0.4) return null;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function pickMajicDrop(isBossWin) {
        if (!isBossWin && Math.random() > 0.6) return null;
        const pickType = (type) => {
            const pool = type === 'eyes' ? GENE_EYES : GENE_MOUTHS;
            const owned = (type === 'eyes' ? gameState.geneEyeMaterials : gameState.geneMouthMaterials) || [];
            const available = pool.filter((emoji) => !owned.includes(emoji));
            return { type, available };
        };
        let { type, available } = pickType(Math.random() < 0.5 ? 'eyes' : 'mouth');
        if (!available.length) {
            const alt = pickType(type === 'eyes' ? 'mouth' : 'eyes');
            type = alt.type;
            available = alt.available;
        }
        if (!available.length) return null;
        return { type, emoji: pickRandom(available) };
    }

    function spawnRoomAtmosphere() {
        const container = document.getElementById('room-atmosphere');
        if (!container || container.children.length) return;
        const count = 8;
        for (let i = 0; i < count; i += 1) {
            const el = document.createElement('div');
            el.className = 'ambient-emoji';
            el.innerText = pickRandom(ROOM_ATMOSPHERE_LIST);
            el.style.left = `${randInt(5, 95)}%`;
            el.style.top = `${randInt(5, 85)}%`;
            el.style.fontSize = `${(randInt(18, 32) / 10).toFixed(1)}rem`;
            el.style.opacity = (Math.random() * 0.25 + 0.15).toFixed(2);
            el.style.animationDuration = `${randInt(5, 9)}s`;
            el.style.animationDelay = `${randInt(0, 4)}s`;
            container.appendChild(el);
        }
    }

    function showCatSpeech() {
        const bubble = document.getElementById('cat-speech');
        if (!bubble) return;
        bubble.innerText = pickRandom(CAT_SPEECH_LIST);
        bubble.classList.remove('hidden');
        if (catSpeechTimer) clearTimeout(catSpeechTimer);
        catSpeechTimer = setTimeout(() => {
            bubble.classList.add('hidden');
        }, 1200);
    }

    // é¡¯ç¤ºçµç®—ç•«é¢
    function finishLevel(isBossWin = false) {
        const reward = isBossWin ? 1 : studyQueue.length;

        const rewardTitle = document.getElementById('reward-title');
        const rewardIcon = document.getElementById('reward-icon');
        const rewardType = document.getElementById('reward-type');
        const rewardExpInfo = document.getElementById('reward-exp-info');
        const countSpan = document.getElementById('reward-count');

        pendingMaterialDrop = pickMaterialDrop(isBossWin);
        pendingMajicDrop = pickMajicDrop(isBossWin);
        const rewardExtra = document.getElementById('reward-extra');
        const rewardExtraMajic = document.getElementById('reward-extra-majic');

        if (pendingMaterialDrop) {
            rewardExtra.innerText = `ç²å¾—ç´ æï¼š${pendingMaterialDrop.icon} ${pendingMaterialDrop.name}`;
            rewardExtra.classList.remove('hidden');
        } else {
            rewardExtra.classList.add('hidden');
            rewardExtra.innerText = '';
        }

        if (pendingMajicDrop && rewardExtraMajic) {
            const label = pendingMajicDrop.type === 'eyes' ? 'çœ¼ç¥ç´ æ' : 'å˜´å·´ç´ æ';
            rewardExtraMajic.innerText = `ç²å¾—é­”æ³•ç´ æï¼š${label} ${pendingMajicDrop.emoji}`;
            rewardExtraMajic.classList.remove('hidden');
        } else if (rewardExtraMajic) {
            rewardExtraMajic.classList.add('hidden');
            rewardExtraMajic.innerText = '';
        }

        if (isBossWin) {
            rewardTitle.innerText = "ğŸ† æˆ°å‹é­”ç‹ï¼";
            rewardTitle.className = "text-4xl font-black text-yellow-600 mb-4 animate-bounce";
            rewardIcon.innerText = "ğŸ¥«âœ¨";
            rewardType.innerText = "é»ƒé‡‘ç½é ­";
            rewardExpInfo.classList.remove('hidden');
            countSpan.dataset.isGolden = "true";
            bossPending = false;
        } else {
            rewardTitle.innerText = "ğŸ‰ æ­å–œéé—œï¼";
            rewardTitle.className = "text-4xl font-black text-yellow-500 mb-4 animate-bounce";
            rewardIcon.innerText = "ğŸ¥«";
            rewardType.innerText = "ç½é ­";
            rewardExpInfo.classList.add('hidden');
            countSpan.dataset.isGolden = "false";
            bossPending = true;
        }

        countSpan.innerText = reward;
        document.getElementById('scene-reward').classList.remove('hidden');
        const rewardScene = document.getElementById('scene-reward');
        rewardScene.style.display = 'flex';
        playSound('sfx-win');
    }

    // é ˜å–çå‹µä¸¦å›é¦–é 
    function collectReward(e) {
        try {
            const countSpan = document.getElementById('reward-count');
            const amount = parseInt(countSpan.innerText, 10);
            const isGolden = countSpan.dataset.isGolden === "true";

            if (isGolden) {
                gameState.exp += 50;
                const calculatedLevel = Math.floor(gameState.exp / EXP_PER_LEVEL) + 1;
                if (calculatedLevel > gameState.level) {
                    gameState.level = calculatedLevel;
                    unlockCatSkin(calculatedLevel - 1, true);
                    setTimeout(showLevelUp, 500);
                }
            } else {
                gameState.food += amount;
            }

            if (pendingMaterialDrop) {
                gameState.materialInventory.push(pendingMaterialDrop.id);
                gameState.synthHasNew = true;
                pendingMaterialDrop = null;
            }
            if (pendingMajicDrop) {
                const list = pendingMajicDrop.type === 'eyes'
                    ? gameState.geneEyeMaterials
                    : gameState.geneMouthMaterials;
                if (!list.includes(pendingMajicDrop.emoji)) {
                    list.push(pendingMajicDrop.emoji);
                    gameState.synthHasNew = true;
                }
                pendingMajicDrop = null;
            }
            saveGame();
        } catch(e) { console.error("Save error"); }

        const rect = e?.target?.getBoundingClientRect();
        const x = rect ? rect.left + rect.width / 2 : window.innerWidth / 2;
        const y = rect ? rect.top : window.innerHeight / 2;
        spawnParticles(x, y, ['ğŸ’°', 'ğŸ‰', 'âœ¨']);

        const rewardScene = document.getElementById('scene-reward');
        rewardScene.classList.add('hidden');
        rewardScene.style.display = 'none'; 

        if (bossPending) {
            bossPending = false;
            window.speechSynthesis.cancel();
            triggerBossEvent();
            return;
        }

        document.getElementById('scene-study').classList.add('hidden');
        document.getElementById('scene-room').classList.remove('hidden');
        resumeRoomBgm();
        window.speechSynthesis.cancel();
    }

    function loadCard() {
        if (currentCardIndex >= studyQueue.length) {
            finishLevel(false);
            return;
        }

        const word = studyQueue[currentCardIndex];
        const cardInner = document.getElementById('study-card');
        
        cardInner.classList.remove('card-flipped');
        document.getElementById('study-controls').classList.add('hidden');
        document.getElementById('tap-hint').classList.remove('hidden'); 

        document.getElementById('q-idx').innerText = currentCardIndex + 1;

        const isMath = word.type === "math";
        const isStory = word.type === "story";
        const studyScene = document.getElementById('scene-study');
        if (studyScene) studyScene.classList.toggle('story-mode', isStory);
        const questionText = isMath ? word.q : isStory ? "æƒ…å¢ƒé¡Œ" : word.z;
        const answerText = isMath || isStory ? word.a : word.c;
        const radicalText = isMath || isStory ? "æ•¸å­¸é¡Œ" : word.r;
        const maskedWord = isStory ? word.w : isMath ? "" : word.w.split(word.c).join("ï¼¿");

        document.getElementById('q-zhuyin').innerText = questionText;
        const hintEl = document.getElementById('q-hint');
        hintEl.innerText = maskedWord;
        hintEl.classList.toggle('story-hint', isStory);

        document.getElementById('q-char').innerText = answerText;
        document.getElementById('q-radical').innerText = radicalText;
        document.getElementById('a-word').innerText = word.w;

        const pct = (currentCardIndex / studyQueue.length) * 100;
        document.getElementById('study-progress').style.width = `${pct}%`;

        speak(isStory ? word.w : isMath ? word.q : word.w);
    }

    function flipCard() {
        const cardInner = document.getElementById('study-card');
        
        if (!cardInner.classList.contains('card-flipped')) {
            cardInner.classList.add('card-flipped');
            document.getElementById('study-controls').classList.remove('hidden');
            document.getElementById('tap-hint').classList.add('hidden'); 
            
            playSound('sfx-flip');
            
            const word = studyQueue[currentCardIndex];
            const isMath = word.type === "math";
            const isStory = word.type === "story";
            const answerText = isMath || isStory ? word.a : word.c;
            speak(answerText + "ã€‚" + word.w);
        }
    }

    function answer(isCorrect) {
        const controls = document.getElementById('study-controls');
        controls.style.pointerEvents = 'none';

        if (isCorrect) {
            playSound('sfx-correct');
            currentCardIndex++;
            setTimeout(() => {
                loadCard();
                controls.style.pointerEvents = 'auto';
            }, 600);
        } else {
            playSound('sfx-wrong');
            const word = studyQueue[currentCardIndex];
            studyQueue.push(word);
            
            setTimeout(() => {
                document.getElementById('study-card').classList.remove('card-flipped');
                document.getElementById('study-controls').classList.add('hidden');
                document.getElementById('tap-hint').classList.remove('hidden');
                
                const retryText = word.type === "math" ? word.q : word.type === "story" ? word.w : word.z;
                speak("å†è©¦ä¸€æ¬¡: " + retryText);
                controls.style.pointerEvents = 'auto';
            }, 1000);
        }
    }

    // --- 4. èªéŸ³ ---
    const synth = window.speechSynthesis;
    function speak(text) {
        if (synth.speaking) synth.cancel();
        
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-TW';
        utter.rate = 0.8;
        synth.speak(utter);
    }

    function toggleMusic() {
        try {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('btn-music');
            if (bgm.paused) {
                if (!bgm.src) setRandomBgm(false);
                bgm.volume = 0.2;
                bgm.play().catch(() => {});
                btn.innerText = "ğŸ”Š";
                gameState.musicOn = true;
            } else {
                bgm.pause();
                btn.innerText = "ğŸ”‡";
                gameState.musicOn = false;
            }
        } catch(e) {}
    }

    function handleVisibilityChange() {
        const bgm = document.getElementById('bgm');
        const bossBgm = document.getElementById('sfx-boss-bgm');
        if (document.hidden) {
            bgmWasPlaying = bgm ? !bgm.paused : false;
            bossBgmWasPlaying = bossBgm ? !bossBgm.paused : false;
            if (bgm) bgm.pause();
            if (bossBgm) bossBgm.pause();
        } else if (gameState.musicOn) {
            if (bossBgmWasPlaying && bossBgm) {
                bossBgm.play().catch(() => {});
            } else if (bgmWasPlaying && bgm) {
                bgm.play().catch(() => {});
            }
        }
    }

    // ç¢ºä¿ DOM è¼‰å…¥å¾Œæ‰åŸ·è¡Œï¼Œé¿å…æ‰¾ä¸åˆ°å…ƒç´ éŒ¯èª¤
    document.addEventListener('DOMContentLoaded', () => {
        loadGame();
        setRandomBgm(false);
        spawnRoomAtmosphere();
        const bgm = document.getElementById('bgm');
        if (bgm) {
            bgm.addEventListener('ended', () => setRandomBgm(true));
            bgm.addEventListener('error', () => setRandomBgm(true));
        }
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('pagehide', () => {
            const bgmEl = document.getElementById('bgm');
            if (bgmEl) bgmEl.pause();
            const bossBgmEl = document.getElementById('sfx-boss-bgm');
            if (bossBgmEl) bossBgmEl.pause();
        });
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').catch(() => {});
        }
    });

</script>
</body>
</html>
