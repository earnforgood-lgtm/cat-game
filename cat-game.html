<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± è²“å’ªå°å­¸å ‚ï¼šç”Ÿå­—å¤§å†’éšª (é™¤éŒ¯ç‰ˆ)</title>
    <!-- å¼•å…¥å­—å‹èˆ‡åœ–ç¤ºåº« -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@500;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éŠæˆ²å°ˆå±¬æ¨£å¼ */
        :root {
            --primary: #FF9F1C;
            --secondary: #FFBF69;
            --bg-color: #CBF3F0;
            --text: #2EC4B6;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-position: 0 0, 50px 50px;
            background-size: 100px 100px;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            height: 100dvh;
        }

        /* 3D æŒ‰éˆ•æ•ˆæœ */
        .btn-3d {
            transition: all 0.1s;
            box-shadow: 0px 5px 0px 0px rgba(0,0,0,0.2);
            transform: translateY(0);
            cursor: pointer;
        }
        .btn-3d:active {
            transform: translateY(5px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.2);
        }

        /* å¡ç‰‡ç¿»è½‰æ ¸å¿ƒ */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .card-inner.card-flipped { transform: rotateY(180deg); }

        /* è²“å’ªæµ®å‹•å‹•ç•« */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .cat-anim { animation: float 3s ease-in-out infinite; }

        /* è²“å’ªç”Ÿæ°£æŠ–å‹•å‹•ç•« */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .cat-angry { animation: shake 0.5s; }

        /* è¡¨æƒ…ç¬¦è™Ÿå‹•ç•« */
        @keyframes icon-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
        .float-icon {
            position: absolute;
            font-size: 3rem;
            animation: icon-float 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }

        .exp-fill { transition: width 0.5s ease-out; }
        
        #start-screen, #scene-reward {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="w-screen flex flex-col items-center justify-center text-gray-800">

    <!-- éŸ³æ•ˆè³‡æºåº« -->
    <audio id="bgm" preload="auto"></audio>
    <audio id="sfx-correct" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-extra-bonus-in-a-video-game-2045.wav"></audio>
    <audio id="sfx-wrong" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-game-show-wrong-answer-buzz-950.wav"></audio>
    <audio id="sfx-meow" preload="auto" src="sound/meow1.mp3"></audio>
    <audio id="sfx-real-meow" preload="auto" src="sound/meow2.mp3"></audio>
    <audio id="sfx-angry" preload="auto" src="sound/an1.mp3"></audio>
    <audio id="sfx-levelup" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-quick-win-video-game-notification-269.wav"></audio>
    <audio id="sfx-flip" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-paper-slide-1530.wav"></audio>
    <audio id="sfx-win" preload="auto" src="https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.wav"></audio>

    <!-- 0. å•Ÿå‹•ç•«é¢ -->
    <div id="start-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border-4 border-orange-300">
            <div class="text-6xl mb-4 animate-bounce">ğŸ±</div>
            <h1 class="text-3xl font-black text-gray-800 mb-2">è²“å’ªå°å­¸å ‚</h1>
            <p class="text-gray-500 mb-8">æº–å‚™å¥½å¹«è²“å’ªè³ºç½é ­äº†å—ï¼Ÿ</p>
            <button onclick="unlockAudioAndStart()" class="w-full btn-3d bg-orange-500 text-white text-xl font-bold py-4 rounded-xl border-b-4 border-orange-700 active:border-orange-500">
                â–¶ï¸ é»æˆ‘é–‹å§‹éŠæˆ²
            </button>
            <p class="mt-4 text-xs text-gray-400">è«‹ç¢ºèªå¹³æ¿è²éŸ³å·²é–‹å•Ÿ</p>
        </div>
    </div>

    <!-- 1. ä¸»ç•«é¢ (æˆ¿é–“) -->
    <div id="scene-room" class="w-full max-w-md h-full flex flex-col p-4 relative hidden opacity-0 transition-opacity duration-500">
        
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
        <div class="flex justify-between items-center bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg mb-2 border-2 border-white">
            <div class="flex items-center gap-2 min-w-fit">
                <span class="text-2xl">ğŸ†</span>
                <span class="font-bold text-lg">Lv.<span id="ui-level">1</span></span>
            </div>
            
            <div class="flex-1 mx-3 flex flex-col justify-center">
                <!-- é€™è£¡è£œå›äº†é¡¯ç¤ºç¶“é©—å€¼çš„æ–‡å­—å€å¡Š -->
                <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                    <span>EXP</span>
                    <span id="ui-exp-text">0/10</span>
                </div>
                <!-- é€²åº¦æ¢ -->
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden border border-gray-300">
                    <div id="ui-exp-bar" class="exp-fill bg-green-400 h-full shadow-[0_0_10px_rgba(74,222,128,0.5)]" style="width: 0%"></div>
                </div>
            </div>

            <button id="btn-music" onclick="toggleMusic()" class="mr-2 p-2 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition">
                ğŸ”Š
            </button>

            <div class="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-xl border border-yellow-200 shadow-sm min-w-fit">
                <span class="text-xl">ğŸ¥«</span>
                <span id="ui-food" class="font-bold text-orange-600">0</span>
            </div>
        </div>

        <!-- è²“å’ªäº’å‹•å€ -->
        <div class="flex-1 flex flex-col items-center justify-center relative min-h-0">
            <div id="cat-container" class="relative cursor-pointer cat-anim active:scale-95 transition-transform duration-100" onclick="petCat(event)">
                <img id="cat-image" src="https://robohash.org/egg?set=set4&size=250x250" class="w-64 h-64 max-h-[40vh] object-contain drop-shadow-2xl" alt="Cat">
                <div id="cat-speech" class="absolute -top-10 right-0 bg-white p-3 rounded-2xl rounded-bl-none shadow-md text-sm hidden font-bold text-gray-600 animate-bounce">
                    å–µå‘œï½
                </div>
            </div>
            <p class="mt-4 text-gray-500 text-sm bg-white/60 px-6 py-2 rounded-full backdrop-blur-sm shadow-sm animate-pulse">ğŸ‘† é»æ“Šè²“å’ªäº’å‹•</p>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
        <div class="grid grid-cols-2 gap-4 mt-2 mb-4 shrink-0">
            <button onclick="feedCat()" class="btn-3d bg-orange-400 hover:bg-orange-500 text-white py-4 rounded-2xl text-xl font-bold flex items-center justify-center gap-2 border-b-4 border-orange-600">
                <span>ğŸŸ</span> é¤µé£Ÿ <span class="text-sm opacity-80">(1exp)</span>
            </button>
            <button onclick="openMenu()" class="btn-3d bg-blue-400 hover:bg-blue-500 text-white py-4 rounded-2xl text-xl font-bold flex items-center justify-center gap-2 border-b-4 border-blue-600">
                <span>âœï¸</span> å»æ‰“å·¥
            </button>
        </div>
    </div>

    <!-- 2. é¸èª²é¸å–® -->
    <div id="scene-menu" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-[fadeIn_0.3s_ease-out] border-4 border-blue-200 flex flex-col max-h-[90dvh]">
            <h2 class="text-2xl font-black text-center mb-4 text-gray-700 flex items-center justify-center gap-2 shrink-0">
                <span>ğŸ“š</span> é¸æ“‡èª²ç¨‹
            </h2>
            <div class="grid grid-cols-2 gap-3 overflow-y-auto p-1 flex-1" id="lesson-list">
                <!-- JS ç”ŸæˆæŒ‰éˆ• -->
            </div>
            <button onclick="closeMenu()" class="mt-4 w-full py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-xl font-bold btn-3d border-b-4 border-gray-600 shrink-0">è¿”å›æˆ¿é–“</button>
        </div>
    </div>

    <!-- 3. æˆ°é¬¥ç•«é¢ -->
    <div id="scene-study" class="hidden fixed inset-0 bg-[#FFF3E0] z-40 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md flex justify-between items-center mb-4 px-2">
            <div class="text-gray-500 font-bold">ç¬¬ <span id="q-idx">1</span> é¡Œ</div>
            <button onclick="quitStudy()" class="text-gray-400 hover:text-red-500 font-bold px-3 py-1 rounded-lg hover:bg-red-50 transition">é€ƒè·‘ ğŸ³ï¸</button>
        </div>
        <div class="w-full max-w-md h-3 bg-gray-200 rounded-full mb-8 shadow-inner overflow-hidden">
            <div id="study-progress" class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="perspective-1000 w-full max-w-xs h-96 cursor-pointer mb-8 relative group" onclick="flipCard()">
            <div id="tap-hint" class="absolute -right-4 top-1/2 z-10 animate-bounce bg-white/80 p-2 rounded-full shadow-lg pointer-events-none">ğŸ‘†</div>
            <div id="study-card" class="card-inner relative w-full h-full transform-style-3d shadow-xl rounded-3xl transition-all duration-500">
                <div class="absolute w-full h-full backface-hidden bg-white rounded-3xl flex flex-col items-center justify-center border-4 border-blue-200 shadow-lg p-4">
                    <span class="text-4xl mb-2 opacity-50">ğŸ”Š</span>
                    <h2 id="q-zhuyin" class="text-8xl font-black text-gray-800 tracking-widest my-2 select-none"></h2>
                    <div class="mt-4 bg-blue-50 px-6 py-3 rounded-2xl border border-blue-100 flex items-center justify-center gap-2 w-full">
                        <span class="text-gray-400 text-sm absolute top-2 left-4">æç¤ºï¼š</span>
                        <p id="q-hint" class="text-3xl font-bold text-blue-600 tracking-widest"></p>
                    </div>
                    <p class="text-gray-400 mt-4 text-xs">å¯«å®Œå¾Œé»æˆ‘ç¿»ç‰Œ</p>
                </div>
                <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-blue-50 rounded-3xl flex flex-col items-center justify-center border-4 border-blue-400 shadow-lg p-4">
                    <h2 id="q-char" class="text-9xl font-black text-red-500 mb-2 font-[KaiTi] select-none"></h2>
                    <div class="flex flex-col items-center gap-2 w-full">
                         <p id="q-radical" class="text-lg bg-blue-200 text-blue-900 px-3 py-1 rounded-lg font-bold shadow-sm"></p>
                         <div class="w-full bg-white/50 rounded-xl py-2 mt-2">
                            <p id="a-word" class="text-2xl font-bold text-gray-700"></p>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="study-controls" class="hidden flex gap-4 w-full max-w-md animate-[fadeIn_0.5s_ease-out]">
            <button onclick="answer(false)" class="flex-1 py-4 bg-red-400 hover:bg-red-500 text-white rounded-2xl font-bold shadow-md transform transition active:scale-95 border-b-4 border-red-600 text-lg">âŒ å†ç·´ä¸€æ¬¡</button>
            <button onclick="answer(true)" class="flex-1 py-4 bg-green-400 hover:bg-green-500 text-white rounded-2xl font-bold shadow-md transform transition active:scale-95 border-b-4 border-green-600 text-lg">âœ… æˆ‘å¯«å°äº†</button>
        </div>
    </div>

    <!-- 4. çµç®—çå‹µç•«é¢ -->
    <div id="scene-reward" class="hidden fixed inset-0 z-[9999] flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border-4 border-yellow-300 relative">
            <h2 class="text-4xl font-black text-yellow-500 mb-4 animate-bounce">ğŸ‰ æ­å–œéé—œï¼</h2>
            <div class="text-8xl mb-4">ğŸ¥«</div>
            <p class="text-2xl text-gray-700 mb-6 font-bold">ç²å¾—äº† <span id="reward-count" class="text-red-500 text-4xl">0</span> å€‹ç½é ­</p>
            <button onclick="collectReward()" class="w-full btn-3d bg-green-500 text-white text-xl font-bold py-4 rounded-xl border-b-4 border-green-700 active:border-green-500" style="pointer-events: auto;">
                ğŸ’° æ”¶ä¸‹ç½é ­å›å®¶
            </button>
        </div>
    </div>

    <!-- å‡ç´šç‰¹æ•ˆ -->
    <div id="levelup-overlay" class="hidden fixed inset-0 bg-black/80 z-[80] flex flex-col items-center justify-center text-white text-center pointer-events-none">
        <h1 class="text-7xl font-bold text-yellow-300 mb-4 animate-bounce drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">LEVEL UP!</h1>
        <p class="text-3xl font-bold text-white mb-8">è²“å’ªé€²åŒ–äº†ï¼âœ¨</p>
        <div class="text-6xl animate-pulse">ğŸ˜»</div>
    </div>

<script>
    // --- 0. è³‡æ–™åº« ---
    const lessons = {
        "7": { title: "ç¬¬ä¸ƒèª²", words: [
            {c:"æ¨£",z:"ã„§ã„¤Ë‹",r:"æœ¨éƒ¨",w:"æ¨£å­"}, {c:"é£Ÿ",z:"ã„•ËŠ",r:"é£Ÿéƒ¨",w:"é£Ÿå“"}, {c:"éƒŠ",z:"ã„ã„§ã„ ",r:"é‚‘éƒ¨",w:"éƒŠå¤–"}, {c:"æ´»",z:"ã„ã„¨ã„›ËŠ",r:"æ°´éƒ¨",w:"ç”Ÿæ´»"},
            {c:"å¥‡",z:"ã„‘ã„§ËŠ",r:"å¤§éƒ¨",w:"å¥‡æ€ª"}, {c:"ç­’",z:"ã„Šã„¨ã„¥Ë‡",r:"ç«¹éƒ¨",w:"ç«¹ç­’"}, {c:"é¦™",z:"ã„’ã„§ã„¤",r:"é¦™éƒ¨",w:"é¦™æ°´"}, {c:"å‘³",z:"ã„¨ã„ŸË‹",r:"å£éƒ¨",w:"å‘³é“"},
            {c:"ä¾¿",z:"ã„…ã„§ã„¢Ë‹",r:"äººéƒ¨",w:"æ–¹ä¾¿"}, {c:"ç•¶",z:"ã„‰ã„¤",r:"ç”°éƒ¨",w:"ä¾¿ç•¶"}, {c:"ç›’",z:"ã„ã„œËŠ",r:"çš¿éƒ¨",w:"ç›’å­"}, {c:"å®¢",z:"ã„ã„œË‹",r:"å®€éƒ¨",w:"å®¢äºº"},
            {c:"æ¸…",z:"ã„‘ã„§ã„¥",r:"æ°´éƒ¨",w:"æ¸…æ°´"}, {c:"ç¯€",z:"ã„ã„§ã„ËŠ",r:"ç«¹éƒ¨",w:"ç¯€æ—¥"}, {c:"ä¿",z:"ã„…ã„ Ë‡",r:"äººéƒ¨",w:"ä¿è­·"}, {c:"å¹³",z:"ã„†ã„§ã„¥ËŠ",r:"å¹²éƒ¨",w:"å¹³å®‰"},
            {c:"å®‰",z:"ã„¢",r:"å®€éƒ¨",w:"å®‰å…¨"}, {c:"å—",z:"ã„‹ã„¢ËŠ",r:"åéƒ¨",w:"å—æ–¹"}
        ]},
        "8": { title: "ç¬¬å…«èª²", words: [
            {c:"ä»‹",z:"ã„ã„§ã„Ë‹",r:"äººéƒ¨",w:"ä»‹ç´¹"}, {c:"åœ’",z:"ã„©ã„¢ËŠ",r:"å›—éƒ¨",w:"å…¬åœ’"}, {c:"å½¢",z:"ã„’ã„§ã„¥ËŠ",r:"å½¡éƒ¨",w:"å½¢ç‹€"}, {c:"ç™½",z:"ã„…ã„ËŠ",r:"ç™½éƒ¨",w:"ç™½è‰²"},
            {c:"ç´™",z:"ã„“Ë‡",r:"ç³¸éƒ¨",w:"ç™½ç´™"}, {c:"ç±³",z:"ã„‡ã„§Ë‡",r:"ç±³éƒ¨",w:"ç™½ç±³"}, {c:"è®Š",z:"ã„…ã„§ã„¢Ë‹",r:"è¨€éƒ¨",w:"æ”¹è®Š"}, {c:"è»Ÿ",z:"ã„–ã„¨ã„¢Ë‡",r:"è»Šéƒ¨",w:"æŸ”è»Ÿ"},
            {c:"æ¶",z:"ã„‘ã„§ã„¤Ë‡",r:"æ‰‹éƒ¨",w:"æ¶èµ°"}, {c:"æ",z:"ã„˜ã„ËŠ",r:"æœ¨éƒ¨",w:"ææ–™"}, {c:"è¦",z:"ã„’ã„§ã„š",r:"è™«éƒ¨",w:"è¦å­"}, {c:"ç·š",z:"ã„’ã„§ã„¢Ë‹",r:"ç³¸éƒ¨",w:"æ¯›ç·š"},
            {c:"å„",z:"ã„ã„œË‹",r:"å£éƒ¨",w:"å„ç¨®"}, {c:"ç¨®",z:"ã„“ã„¨ã„¥Ë‡",r:"ç¦¾éƒ¨",w:"ç¨®å­"}, {c:"èœ",z:"ã„˜ã„Ë‹",r:"è‰¸éƒ¨",w:"é’èœ"}, {c:"è½",z:"ã„Šã„§ã„¥",r:"è€³éƒ¨",w:"è½è¦‹"},
            {c:"æ›´",z:"ã„ã„¥Ë‹",r:"æ›°éƒ¨",w:"æ›´åŠ "}, {c:"æ¥",z:"ã„ã„§ã„",r:"æ‰‹éƒ¨",w:"æ¥å—"}
        ]},
        "9": { title: "ç¬¬ä¹èª²", words: [
            {c:"é»ƒ",z:"ã„ã„¨ã„¤ËŠ",r:"é»ƒéƒ¨",w:"é»ƒè‰²"}, {c:"æ²–",z:"ã„”ã„¨ã„¥",r:"æ°´éƒ¨",w:"æ²–æ´—"}, {c:"æ¾¡",z:"ã„—ã„ Ë‡",r:"æ°´éƒ¨",w:"æ´—æ¾¡"}, {c:"è˜¿",z:"ã„Œã„¨ã„›ËŠ",r:"è‰¸éƒ¨",w:"è˜¿è””"},
            {c:"è””",z:"ã„…ã„›Ë™",r:"è‰¸éƒ¨",w:"è˜¿è””"}, {c:"å“ª",z:"ã„‹ã„šË‡",r:"å£éƒ¨",w:"å“ªè£¡"}, {c:"ç²’",z:"ã„Œã„§Ë‹",r:"ç±³éƒ¨",w:"ç±³ç²’"}, {c:"ç†±",z:"ã„–ã„œË‹",r:"ç«éƒ¨",w:"ç†±é¬§"},
            {c:"æµ´",z:"ã„©Ë‹",r:"æ°´éƒ¨",w:"æµ´å®¤"}, {c:"è’¸",z:"ã„“ã„¥",r:"ç«éƒ¨",w:"è’¸æ°£"}, {c:"èƒ–",z:"ã„†ã„¤Ë‹",r:"è‚‰éƒ¨",w:"è‚¥èƒ–"}, {c:"å",z:"ã„‡ã„§ã„¥ËŠ",r:"å£éƒ¨",w:"åå­—"},
            {c:"è‹”",z:"ã„Šã„ËŠ",r:"è‰¸éƒ¨",w:"é’è‹”"}, {c:"è›‹",z:"ã„‰ã„¢Ë‹",r:"è™«éƒ¨",w:"é›è›‹"}, {c:"è”¬",z:"ã„•ã„¨",r:"è‰¸éƒ¨",w:"è”¬èœ"}, {c:"é€š",z:"ã„Šã„¨ã„¥",r:"è¾µéƒ¨",w:"é€šé"},
            {c:"ç´°",z:"ã„’ã„§Ë‹",r:"ç³¸éƒ¨",w:"ç´°å°"}
        ]},
        "10": { title: "ç¬¬åèª²", words: [
            {c:"æ¸›",z:"ã„ã„§ã„¢Ë‡",r:"æ°´éƒ¨",w:"æ¸›å°‘"}, {c:"è¡¨",z:"ã„…ã„§ã„ Ë‡",r:"è¡£éƒ¨",w:"èª²è¡¨"}, {c:"è®€",z:"ã„‰ã„¨ËŠ",r:"è¨€éƒ¨",w:"è®€æ›¸"}, {c:"èª",z:"ã„–ã„£Ë‹",r:"è¨€éƒ¨",w:"èªè­˜"},
            {c:"è­˜",z:"ã„•Ë‹",r:"è¨€éƒ¨",w:"çŸ¥è­˜"}, {c:"è¬",z:"ã„‡ã„§ËŠ",r:"è¨€éƒ¨",w:"è¬é¡Œ"}, {c:"ç­”",z:"ã„‰ã„šËŠ",r:"ç«¹éƒ¨",w:"å›ç­”"}, {c:"æ–",z:"ã„§ã„ ËŠ",r:"æ‰‹éƒ¨",w:"æ–é ­"},
            {c:"ç™¾",z:"ã„…ã„Ë‡",r:"ç™½éƒ¨",w:"ä¸€ç™¾"}, {c:"å˜´",z:"ã„—ã„¨ã„ŸË‡",r:"å£éƒ¨",w:"å˜´å·´"}, {c:"å“¥",z:"ã„ã„œ",r:"å£éƒ¨",w:"å“¥å“¥"}, {c:"æ•¸",z:"ã„•ã„¨Ë‡",r:"æ”µéƒ¨",w:"æ•¸å­¸"},
            {c:"é¡Œ",z:"ã„Šã„§ËŠ",r:"é éƒ¨",w:"é¡Œç›®"}, {c:"è¶•",z:"ã„ã„¢Ë‡",r:"èµ°éƒ¨",w:"è¶•å¿«"}, {c:"çª",z:"ã„Šã„¨ËŠ",r:"ç©´éƒ¨",w:"çªç„¶"}, {c:"ç•°",z:"ã„§Ë‹",r:"ç”°éƒ¨",w:"å¥‡ç•°"},
            {c:"å£",z:"ã„ã„¡Ë‡",r:"å£éƒ¨",w:"å£è¢‹"}, {c:"å°",z:"ã„‰ã„¨ã„ŸË‹",r:"å¯¸éƒ¨",w:"å°éŒ¯"}
        ]},
        "11": { title: "ç¬¬åä¸€èª²", words: [
            {c:"æ€ª",z:"ã„ã„¨ã„Ë‹",r:"å¿ƒéƒ¨",w:"å¥‡æ€ª"}, {c:"é–€",z:"ã„‡ã„£ËŠ",r:"é–€éƒ¨",w:"å¤§é–€"}, {c:"æ‰‡",z:"ã„•ã„¢Ë‹",r:"æˆ¶éƒ¨",w:"é›»æ‰‡"}, {c:"ç«‹",z:"ã„Œã„§Ë‹",r:"ç«‹éƒ¨",w:"èµ·ç«‹"},
            {c:"åˆ»",z:"ã„ã„œË‹",r:"åˆ€éƒ¨",w:"ç«‹åˆ»"}, {c:"é–’",z:"ã„’ã„§ã„¢ËŠ",r:"é–€éƒ¨",w:"ç©ºé–’"}, {c:"é¦¬",z:"ã„‡ã„šË‡",r:"é¦¬éƒ¨",w:"é¦¬è·¯"}, {c:"é—–",z:"ã„”ã„¨ã„¤Ë‡",r:"é–€éƒ¨",w:"é—–é—œ"},
            {c:"è€³",z:"ã„¦Ë‡",r:"è€³éƒ¨",w:"è€³æœµ"}, {c:"ä¸»",z:"ã„“ã„¨Ë‡",r:"ä¸¶éƒ¨",w:"ä¸»äºº"}, {c:"æ’­",z:"ã„…ã„›",r:"æ‰‹éƒ¨",w:"å»£æ’­"}, {c:"å ±",z:"ã„…ã„ Ë‹",r:"åœŸéƒ¨",w:"å ±å‘Š"},
            {c:"åŠ›",z:"ã„Œã„§Ë‹",r:"åŠ›éƒ¨",w:"åŠ›æ°£"}, {c:"ç«Ÿ",z:"ã„ã„§ã„¥Ë‹",r:"ç«‹éƒ¨",w:"ç«Ÿç„¶"}, {c:"å·´",z:"ã„…ã„š",r:"å·³éƒ¨",w:"å°¾å·´"}, {c:"æ±",z:"ã„‰ã„¨ã„¥",r:"æœ¨éƒ¨",w:"æ±è¥¿"},
            {c:"è¥¿",z:"ã„’ã„§",r:"è¥¾éƒ¨",w:"è¥¿ç“œ"}, {c:"åº•",z:"ã„‰ã„§Ë‡",r:"å»£éƒ¨",w:"åº•ä¸‹"}
        ]},
        "12": { title: "ç¬¬åäºŒèª²", words: [
            {c:"å¿µ",z:"ã„‹ã„§ã„¢Ë‹",r:"å¿ƒéƒ¨",w:"æ€å¿µ"}, {c:"æ›²",z:"ã„‘ã„©Ë‡",r:"æ›°éƒ¨",w:"æ­Œæ›²"}, {c:"é …",z:"ã„’ã„§ã„¤Ë‹",r:"é éƒ¨",w:"é …ç›®"}, {c:"æµ®",z:"ã„ˆã„¨ËŠ",r:"æ°´éƒ¨",w:"æµ®åŠ›"},
            {c:"æŒ",z:"ã„“ã„¤Ë‡",r:"æ‰‹éƒ¨",w:"æ‰‹æŒ"}, {c:"æ’¥",z:"ã„…ã„›",r:"æ‰‹éƒ¨",w:"æ’¥é–‹"}, {c:"æ³¢",z:"ã„…ã„›",r:"æ°´éƒ¨",w:"æ³¢æµª"}, {c:"è©©",z:"ã„•",r:"è¨€éƒ¨",w:"è©©äºº"},
            {c:"ä½œ",z:"ã„—ã„¨ã„›Ë‹",r:"äººéƒ¨",w:"ä½œæ¥­"}, {c:"é¦–",z:"ã„•ã„¡Ë‡",r:"é¦–éƒ¨",w:"é¦–å…ˆ"}, {c:"æŒ‡",z:"ã„“Ë‡",r:"æ‰‹éƒ¨",w:"æ‰‹æŒ‡"}, {c:"ä¼¸",z:"ã„•ã„£",r:"äººéƒ¨",w:"ä¼¸æ‰‹"},
            {c:"è„–",z:"ã„…ã„›ËŠ",r:"è‚‰éƒ¨",w:"è„–å­"}, {c:"èº«",z:"ã„•ã„£",r:"èº«éƒ¨",w:"èº«é«”"}, {c:"é«”",z:"ã„Šã„§Ë‡",r:"éª¨éƒ¨",w:"é«”è‚²"}, {c:"éš»",z:"ã„“",r:"éš¹éƒ¨",w:"ä¸€éš»"},
            {c:"å€’",z:"ã„‰ã„ Ë‡",r:"äººéƒ¨",w:"è·Œå€’"}, {c:"è‚š",z:"ã„‰ã„¨Ë‹",r:"è‚‰éƒ¨",w:"è‚šå­"}
        ]}
    };

    // --- 1. éŠæˆ²ç‹€æ…‹ç®¡ç† ---
    let gameState = {
        level: 1,
        exp: 0,
        food: 0,
        musicOn: true 
    };
    
    const EXP_PER_LEVEL = 10;
    const HAPPY_MEOW_LIST = [
        "sound/meow1.mp3",
        "sound/meow2.mp3",
        "sound/meow3.mp3",
        "sound/meow4.mp3"
    ];
    const ANGRY_MEOW_LIST = [
        "sound/an1.mp3",
        "sound/an2.mp3"
    ];
    const BGM_LIST = [
        "music/å…”å…’è·³ä¸åœ.mp3",
        "music/æ´—æ´—ç¢—.mp3",
        "music/æ´—ç¢—.mp3",
        "music/æ´—ç¢—æ´—ç¢—æ´—ç¢—ç¢—.mp3",
        "music/è¦æ‹‰æ‹‰ .mp3"
    ];
    let currentBgmUrl = "";
    let bgmQueue = [];
    let bgmWasPlaying = false;

    const catSprites = [
        "https://robohash.org/egg?set=set4&size=250x250", 
        "https://robohash.org/baby_kitten?set=set4&size=250x250", 
        "https://robohash.org/playful_cat?set=set4&size=250x250", 
        "https://robohash.org/smart_cat?set=set4&size=250x250", 
        "https://robohash.org/ninja_cat?set=set4&size=250x250", 
        "https://robohash.org/wizard_cat?set=set4&size=250x250",
        "https://robohash.org/king_cat?set=set4&size=250x250",
        "https://robohash.org/queen_cat?set=set4&size=250x250",
        "https://robohash.org/angel_cat?set=set4&size=250x250",
        "https://robohash.org/demon_cat?set=set4&size=250x250",
        "https://robohash.org/space_cat?set=set4&size=250x250",
        "https://robohash.org/robot_cat?set=set4&size=250x250",
        "https://robohash.org/ghost_cat?set=set4&size=250x250",
        "https://robohash.org/super_cat?set=set4&size=250x250",
        "https://robohash.org/mega_cat?set=set4&size=250x250",
        "https://robohash.org/ultra_cat?set=set4&size=250x250",
        "https://robohash.org/rainbow_cat?set=set4&size=250x250",
        "https://robohash.org/golden_cat?set=set4&size=250x250",
        "https://robohash.org/crystal_cat?set=set4&size=250x250",
        "https://robohash.org/shadow_cat?set=set4&size=250x250",
        "https://robohash.org/fire_cat?set=set4&size=250x250",
        "https://robohash.org/water_cat?set=set4&size=250x250",
        "https://robohash.org/earth_cat?set=set4&size=250x250",
        "https://robohash.org/wind_cat?set=set4&size=250x250",
        "https://robohash.org/god_cat?set=set4&size=250x250"
    ];

    function loadGame() {
        const saved = localStorage.getItem('catGameSave');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
            } catch(e) {}
        }
        if (gameState.musicOn === undefined) gameState.musicOn = true;
        gameState.level = Math.max(1, Math.floor(gameState.exp / EXP_PER_LEVEL) + 1);
        updateRoomUI();
    }

    function pickRandomBgmUrl() {
        if (!BGM_LIST.length) return "";
        const idx = Math.floor(Math.random() * BGM_LIST.length);
        return BGM_LIST[idx];
    }

    function pickRandom(list) {
        if (!list.length) return "";
        const idx = Math.floor(Math.random() * list.length);
        return list[idx];
    }

    function shuffle(list) {
        const copy = [...list];
        for (let i = copy.length - 1; i > 0; i -= 1) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
    }

    function nextBgmUrl() {
        if (!BGM_LIST.length) return "";
        if (bgmQueue.length === 0) {
            bgmQueue = shuffle(BGM_LIST);
            if (bgmQueue.length > 1 && bgmQueue[0] === currentBgmUrl) {
                bgmQueue.push(bgmQueue.shift());
            }
        }
        return bgmQueue.shift();
    }

    function normalizeAudioSrc(path) {
        if (!path) return "";
        return path.startsWith("http") ? path : encodeURI(path);
    }

    function setRandomBgm(shouldPlay) {
        const bgm = document.getElementById('bgm');
        if (!bgm) return;
        let nextUrl = normalizeAudioSrc(nextBgmUrl());
        if (!nextUrl) return;
        if (bgm.src !== nextUrl) {
            bgm.src = nextUrl;
        }
        currentBgmUrl = nextUrl;
        bgm.load();
        if (shouldPlay && gameState.musicOn) {
            bgm.volume = 0.2;
            bgm.play().catch(() => {});
        }
    }

    function saveGame() {
        localStorage.setItem('catGameSave', JSON.stringify(gameState));
        updateRoomUI();
    }

    function updateRoomUI() {
        // å®‰å…¨æª¢æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨å ±éŒ¯
        const uiLevel = document.getElementById('ui-level');
        const uiFood = document.getElementById('ui-food');
        const uiExpText = document.getElementById('ui-exp-text');
        const uiExpBar = document.getElementById('ui-exp-bar');
        const catImg = document.getElementById('cat-image');

        if (uiLevel) uiLevel.innerText = gameState.level;
        if (uiFood) uiFood.innerText = gameState.food;
        
        const currentExp = gameState.exp % EXP_PER_LEVEL;
        const pct = (currentExp / EXP_PER_LEVEL) * 100;

        if (gameState.level > catSprites.length) {
            if (uiExpText) uiExpText.innerText = "MAX";
            if (uiExpBar) uiExpBar.style.width = "100%";
        } else {
            if (uiExpText) uiExpText.innerText = `${currentExp}/${EXP_PER_LEVEL}`;
            if (uiExpBar) uiExpBar.style.width = `${pct}%`;
        }

        let spriteIndex = Math.min(gameState.level - 1, catSprites.length - 1);
        if (spriteIndex < 0) spriteIndex = 0;

        if (catImg) catImg.src = catSprites[spriteIndex];
    }

    // --- éŸ³æ•ˆæ’­æ”¾ (å«å®‰å…¨æ©Ÿåˆ¶) ---
    function playSound(id) {
        try {
            const audio = document.getElementById(id);
            if (audio) {
                audio.muted = false;
                audio.currentTime = 0;
                audio.volume = 0.5;
                const promise = audio.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.log("Sound play error (safe):", id);
                    });
                }
            }
        } catch(e) {
            console.log("Audio Element missing or error");
        }
    }

    function unlockAudioAndStart() {
        // å˜—è©¦è§£é–æ‰€æœ‰éŸ³æ•ˆ
        const audios = ['bgm', 'sfx-correct', 'sfx-wrong', 'sfx-meow', 'sfx-levelup', 'sfx-flip', 'sfx-angry', 'sfx-win', 'sfx-real-meow'];
        audios.forEach(id => {
            try {
                const el = document.getElementById(id);
                if(el) {
                    if (id === 'bgm' && !el.src) setRandomBgm(true);
                    el.muted = true;
                    el.load();
                    const playPromise = el.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            el.pause();
                            el.currentTime = 0;
                            el.muted = false;
                            if(id === 'bgm' && gameState.musicOn) {
                                el.volume = 0.2;
                                el.play().catch(() => {});
                            }
                        }).catch(() => {
                            el.muted = false;
                        });
                    } else {
                        el.muted = false;
                        if(id === 'bgm' && gameState.musicOn) {
                            el.volume = 0.2;
                            el.play().catch(() => {});
                        }
                    }
                }
            } catch(e) {}
        });

        // è§£é–èªéŸ³
        try {
            const synth = window.speechSynthesis;
            const utter = new SpeechSynthesisUtterance('');
            synth.speak(utter);
        } catch(e) {}

        document.getElementById('start-screen').style.display = 'none';
        const room = document.getElementById('scene-room');
        room.classList.remove('hidden');
        setTimeout(() => room.classList.remove('opacity-0'), 50);
    }

    // --- 2. è²“å’ªäº’å‹• ---
    function petCat(e) {
        e.stopPropagation();
        
        const isHappy = Math.random() > 0.3;
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX || (rect.left + rect.width/2);
        const y = e.clientY || (rect.top + rect.height/2);
        
        const icon = document.createElement('div');
        icon.className = 'float-icon';
        icon.style.left = (x - rect.left) + 'px';
        icon.style.top = (y - rect.top) + 'px';

        const catContainer = document.getElementById('cat-container');
        
        if (isHappy) {
            try {
                const happyUrl = normalizeAudioSrc(pickRandom(HAPPY_MEOW_LIST));
                const realMeow = document.getElementById('sfx-real-meow');
                if (realMeow && happyUrl) {
                    realMeow.src = happyUrl;
                    realMeow.load();
                    realMeow.currentTime = 0;
                    realMeow.play().catch(() => playSound('sfx-meow'));
                } else {
                    playSound('sfx-meow');
                }
            } catch(e) {
                playSound('sfx-meow');
            }

            icon.innerText = "â¤ï¸";
            icon.style.color = "#ff4757";
            catContainer.classList.remove('cat-angry');
        } else {
            try {
                const angryUrl = normalizeAudioSrc(pickRandom(ANGRY_MEOW_LIST));
                const angryMeow = document.getElementById('sfx-angry');
                if (angryMeow && angryUrl) {
                    angryMeow.src = angryUrl;
                    angryMeow.load();
                    angryMeow.currentTime = 0;
                    angryMeow.play().catch(() => playSound('sfx-angry'));
                } else {
                    playSound('sfx-angry');
                }
            } catch(e) {
                playSound('sfx-angry');
            }
            icon.innerText = "ğŸ’¢";
            icon.style.color = "#2f3542";
            catContainer.classList.remove('cat-angry'); 
            void catContainer.offsetWidth; 
            catContainer.classList.add('cat-angry');
        }

        catContainer.appendChild(icon);
        setTimeout(() => icon.remove(), 1000);
    }

    function feedCat() {
        if (gameState.food <= 0) {
            alert("ç½é ­ä¸å¤ äº†ï¼å¿«å»ã€Œå»æ‰“å·¥ã€è³ºç½é ­å§ï¼");
            return;
        }

        gameState.food--;
        gameState.exp += 1;
        playSound('sfx-correct'); 
        
        const calculatedLevel = Math.floor(gameState.exp / EXP_PER_LEVEL) + 1;
        
        if (calculatedLevel > gameState.level) {
            gameState.level = calculatedLevel;
            showLevelUp();
        }

        saveGame();
    }

    function showLevelUp() {
        playSound('sfx-levelup');
        const overlay = document.getElementById('levelup-overlay');
        overlay.classList.remove('hidden');
        setTimeout(() => {
            overlay.classList.add('hidden');
        }, 3000);
    }

    // --- 3. å­¸ç¿’ç³»çµ± ---
    let studyQueue = [];
    let currentCardIndex = 0;
    
    function openMenu() {
        document.getElementById('scene-menu').classList.remove('hidden');
        const list = document.getElementById('lesson-list');
        list.innerHTML = '';
        
        for (let k in lessons) {
            const btn = document.createElement('button');
            btn.className = "btn-3d p-4 bg-yellow-100 rounded-xl font-bold hover:bg-yellow-200 border-b-4 border-yellow-300 text-lg flex items-center justify-between";
            btn.innerHTML = `<span>ğŸ“š ${lessons[k].title}</span> <span class="text-sm bg-yellow-300 px-2 py-1 rounded-full text-yellow-800">${lessons[k].words.length}å­—</span>`;
            btn.onclick = () => startLevel(k);
            list.appendChild(btn);
        }
    }

    function closeMenu() {
        document.getElementById('scene-menu').classList.add('hidden');
    }

    function startLevel(key) {
        closeMenu();
        studyQueue = [...lessons[key].words].sort(() => Math.random() - 0.5);
        currentCardIndex = 0;
        document.getElementById('scene-study').classList.remove('hidden');
        loadCard();
    }

    function quitStudy() {
        document.getElementById('scene-study').classList.add('hidden');
        window.speechSynthesis.cancel();
    }

    // é¡¯ç¤ºçµç®—ç•«é¢
    function finishLevel() {
        const reward = studyQueue.length;
        document.getElementById('reward-count').innerText = reward;
        document.getElementById('scene-reward').classList.remove('hidden');
        // å¼·åˆ¶ç§»é™¤ hiddenï¼Œä¸¦åŠ ä¸Š flex ç¢ºä¿é¡¯ç¤º
        const rewardScene = document.getElementById('scene-reward');
        rewardScene.style.display = 'flex';
        playSound('sfx-win');
    }

    // é ˜å–çå‹µä¸¦å›é¦–é 
    function collectReward() {
        try {
            const reward = studyQueue.length;
            gameState.food += reward;
            saveGame();
        } catch(e) { console.error("Save error"); }

        const rewardScene = document.getElementById('scene-reward');
        rewardScene.classList.add('hidden');
        rewardScene.style.display = 'none'; 
        
        document.getElementById('scene-study').classList.add('hidden');
        document.getElementById('scene-room').classList.remove('hidden');
        
        window.speechSynthesis.cancel();
    }

    function loadCard() {
        if (currentCardIndex >= studyQueue.length) {
            finishLevel();
            return;
        }

        const word = studyQueue[currentCardIndex];
        const cardInner = document.getElementById('study-card');
        
        cardInner.classList.remove('card-flipped');
        document.getElementById('study-controls').classList.add('hidden');
        document.getElementById('tap-hint').classList.remove('hidden'); 

        document.getElementById('q-idx').innerText = currentCardIndex + 1;

        document.getElementById('q-zhuyin').innerText = word.z;
        const maskedWord = word.w.split(word.c).join("ï¼¿");
        document.getElementById('q-hint').innerText = maskedWord;

        document.getElementById('q-char').innerText = word.c;
        document.getElementById('q-radical').innerText = word.r;
        document.getElementById('a-word').innerText = word.w;

        const pct = (currentCardIndex / studyQueue.length) * 100;
        document.getElementById('study-progress').style.width = `${pct}%`;

        speak(word.w);
    }

    function flipCard() {
        const cardInner = document.getElementById('study-card');
        
        if (!cardInner.classList.contains('card-flipped')) {
            cardInner.classList.add('card-flipped');
            document.getElementById('study-controls').classList.remove('hidden');
            document.getElementById('tap-hint').classList.add('hidden'); 
            
            playSound('sfx-flip');
            
            const word = studyQueue[currentCardIndex];
            speak(word.c + "ã€‚" + word.w);
        }
    }

    function answer(isCorrect) {
        const controls = document.getElementById('study-controls');
        controls.style.pointerEvents = 'none';

        if (isCorrect) {
            playSound('sfx-correct');
            currentCardIndex++;
            setTimeout(() => {
                loadCard();
                controls.style.pointerEvents = 'auto';
            }, 600);
        } else {
            playSound('sfx-wrong');
            const word = studyQueue[currentCardIndex];
            studyQueue.push(word);
            
            setTimeout(() => {
                document.getElementById('study-card').classList.remove('card-flipped');
                document.getElementById('study-controls').classList.add('hidden');
                document.getElementById('tap-hint').classList.remove('hidden');
                
                speak("å†è©¦ä¸€æ¬¡: " + word.z);
                controls.style.pointerEvents = 'auto';
            }, 1000);
        }
    }

    // --- 4. èªéŸ³ ---
    const synth = window.speechSynthesis;
    function speak(text) {
        if (synth.speaking) synth.cancel();
        
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-TW';
        utter.rate = 0.8;
        synth.speak(utter);
    }

    function toggleMusic() {
        try {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('btn-music');
            if (bgm.paused) {
                if (!bgm.src) setRandomBgm(false);
                bgm.volume = 0.2;
                bgm.play().catch(() => {});
                btn.innerText = "ğŸ”Š";
                gameState.musicOn = true;
            } else {
                bgm.pause();
                btn.innerText = "ğŸ”‡";
                gameState.musicOn = false;
            }
        } catch(e) {}
    }

    function handleVisibilityChange() {
        const bgm = document.getElementById('bgm');
        if (!bgm) return;
        if (document.hidden) {
            bgmWasPlaying = !bgm.paused;
            bgm.pause();
        } else if (bgmWasPlaying && gameState.musicOn) {
            bgm.play().catch(() => {});
        }
    }

    // ç¢ºä¿ DOM è¼‰å…¥å¾Œæ‰åŸ·è¡Œï¼Œé¿å…æ‰¾ä¸åˆ°å…ƒç´ éŒ¯èª¤
    document.addEventListener('DOMContentLoaded', () => {
        loadGame();
        setRandomBgm(false);
        const bgm = document.getElementById('bgm');
        if (bgm) {
            bgm.addEventListener('ended', () => setRandomBgm(true));
            bgm.addEventListener('error', () => setRandomBgm(true));
        }
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('pagehide', () => {
            const bgmEl = document.getElementById('bgm');
            if (bgmEl) bgmEl.pause();
        });
    });

</script>
</body>
</html>
